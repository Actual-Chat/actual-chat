@page "/chat"
@page "/chat/{ChatId}"
@inherits ComputedStateComponent<ChatPageModel>
@inject IChatService _chats
@inject IAuthService _auth
@inject Session _session
@inject UICommandRunner _cmd
@inject NavigationManager _nav
@inject ILogger<ChatPage> _log

@{
    var error = State.Error;
    var model = State.LatestNonErrorValue;
    if (model.IsUnavailable)
        _nav.Unavailable("chat");
    if (model.MustLogin)
        _nav.Login("to view this chat");
    var chat = model.Chat ?? new();
}

<h1>"@(chat.Title.NullIfEmpty() ?? "Loading...")" chat</h1>

<WhenException Exception="@error"/>

<h2><Badge Color="Color.Dark">TBD.</Badge></h2>

<p>It's the little details that are vital. Little things make big things happen.</p>

@code {
    [CascadingParameter]
    public Task<AuthState> AuthState { get; set; } = null!;
    [Parameter]
    public string ChatId { get; set; } = "";

    protected override Task OnParametersSetAsync()
    {
        if (string.IsNullOrEmpty(ChatId))
            _nav.NavigateTo($"/chat/{ChatConstants.DefaultChatId}");
        return base.OnParametersSetAsync();
    }

    protected override async Task<ChatPageModel> ComputeState(CancellationToken cancellationToken)
    {
        var chatId = ChatId.NullIfEmpty() ?? ChatConstants.DefaultChatId;
        var user = (await AuthState).User;
        var chat = await _chats.TryGet(_session, chatId, cancellationToken);
        if (chat == null)
            return new ChatPageModel() { IsUnavailable = true };
        if (!user.IsAuthenticated && !chat.IsPublic)
            return new ChatPageModel() { MustLogin = true };
        return new ChatPageModel() {
            Chat = chat,
        };
    }
}
