@using System.Text.Encodings.Web
@using UI.Blazor.Components
@inherits ComputedStateComponent<ImmutableArray<Symbol>>
@{
    var m = State.LatestNonErrorValue;
}

<div class="flex-y gap-y-2">
    @foreach (var avatarId in m) {
        <Tile>
            <TileItem Unselected="true">
                <Icon>
                    <UserAvatar AvatarId="@avatarId" ChatId="@ChatId"/>
                </Icon>
                <Right>
                    <TileButtons OnEditAvatarClick="@(() => EditAvatar(avatarId, "Edit avatar"))"
                                 OnSetDefaultAvatar="@(() => SetDefaultAvatar(avatarId))"
                                 AvatarId="@avatarId"/>
                </Right>
                <Content>
                    <UserAvatar AvatarId="@avatarId" ChatId="@ChatId" Show="UserAvatar.ShowInfo.Name"/>
                </Content>
            </TileItem>

            <TileItem>
                <Icon>
                    <i class="icon-at text-xl"></i>
                </Icon>
                <Content>
                    Id: @avatarId
                </Content>
                <Caption>
                    Avatar Id
                </Caption>
            </TileItem>

            <TileItem>
                <Icon>
                    <i class="icon-info text-xl"></i>
                </Icon>
                <Content>
                    Some bio: <UserAvatar AvatarId="@avatarId" ChatId="@ChatId" Show="UserAvatar.ShowInfo.Bio"/>
                </Content>
                <Caption>
                    Bio
                </Caption>
            </TileItem>
        </Tile>
    }

    <UserAvatarAddTile OnClick="OnAddNewAvatar"/>

</div>

@code {
    private string _defaultAvatarId = "";

    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IUserAvatars UserAvatars { get; init; } = null!;
    [Inject] private IChatUserSettings ChatUserSettings { get; init; } = null!;
    [Inject] private ModalUI ModalUI { get; init; } = null!;
    [Inject] private UICommander UICommander { get; init; } = null!;

    [Parameter] public string ChatId { get; set; } = "";
    [Parameter] public User User { get; set; } = null!;

    protected override ComputedState<ImmutableArray<Symbol>>.Options GetStateOptions()
        => new () { InitialValue = ImmutableArray<Symbol>.Empty };

    protected override async Task<ImmutableArray<Symbol>> ComputeState(CancellationToken cancellationToken) {
        var avatarIds = await UserAvatars.ListAvatarIds(Session, cancellationToken);
        _defaultAvatarId = await UserAvatars.GetDefaultAvatarId(Session, default);
        return avatarIds;
    }

    private async Task OnAddNewAvatar() {
        var command = new IUserAvatars.CreateCommand(Session);
        var avatar = await UICommander.Call(command);
        EditAvatar(avatar.Id, "Add avatar");
    }

    private void EditAvatar(string avatarId, string title) {
        ModalUI.Show(new UserAvatarEditorModal.Model(avatarId, ChatId, title));
    }

    private async Task SetDefaultAvatar(string avatarId) {
        var command = new IUserAvatars.SetDefaultCommand(Session, avatarId);
        await UICommander.Run(command);
    }
}
