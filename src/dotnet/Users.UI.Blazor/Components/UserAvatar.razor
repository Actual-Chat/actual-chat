@inherits ComputedStateComponent<UserAvatar.Model>
@{
    var m = State.LatestNonErrorValue;
}

<div class="user-avatar-card relative">
    <div class="user-avatar-card-content">
        <Pic ContentId="@m.Picture" Title="@m.Name" Size="SquareSize.Size16">
            <NoPicture>
                <AnonymousIcon/>
            </NoPicture>
        </Pic>
        <p class="user-avatar-card-bio">@(m.Bio.NullIfEmpty() ?? "No bio")</p>
    </div>
    <div class="absolute top-0 right-0">
        @if (!m.Tag.IsNullOrEmpty()) {
            <span class="user-avatar-card-tag">@m.Tag</span>
        }
    </div>
</div>

@code {
    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IUserAvatars UserAvatars { get; init; } = null!;
    [Inject] private IChatUserSettings ChatUserSettings { get; init; } = null!;

    [Parameter] public string AvatarId { get; set; } = "";
    [Parameter] public string ChatId { get; set; } = "";

    protected override ComputedState<Model>.Options GetStateOptions()
        => new() { InitialValue = Model.None };

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var userAvatar = await UserAvatars.Get(Session, AvatarId, cancellationToken).ConfigureAwait(false);
        if (userAvatar == null)
            return new Model();

        var defaultAvatarId = await UserAvatars.GetDefaultAvatarId(Session, cancellationToken);
        var activeAvatarId = "";
        if (!ChatId.IsNullOrEmpty()) {
            var chatUserSettings = await ChatUserSettings.Get(Session, ChatId, cancellationToken);
            activeAvatarId = chatUserSettings?.AvatarId ?? "";
        }

        var isActive = OrdinalEquals(activeAvatarId, AvatarId);
        var isDefault = OrdinalEquals(defaultAvatarId, AvatarId);
        var tag = isActive
            ? isDefault ? "active, default" : "active"
            : isDefault ? "default" : "";

        return new Model {
            Picture = userAvatar.Picture,
            Name = userAvatar.Name,
            Bio = userAvatar.Bio,
            Tag = tag,
        };
    }

    public record Model {
        public static Model None { get; } = new();

        public string Name { get; init; } = "";
        public string Picture { get; init; } = "";
        public string Bio { get; init; } = "";
        public string Tag { get; init; } = "";
    }
}
