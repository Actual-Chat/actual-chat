@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager _navigator
@inject UICommandFailureList _commandFailureList
@implements INavbarBackend
@using ActualChat.UI.Blazor.Module
@inject IJSRuntime _js

@{
    var failures = _commandFailureList.Items;
    var version = "v" + (GetType().Assembly.GetInformationalVersion() ?? "n/a").Replace('+', ' ');
}
<NavbarIcon />
<div class="flex-1 flex flex-row justify-items-stretch h-full max-h-full overflow-y-hidden relative bg-primary">
    <input id="navbar-toggle" class="hidden" type="checkbox" />
    <nav id="navbar-links" class="bg-primary text-primary z-50 absolute top-0 left-0 h-full md:static flex flex-col justify-between transform -translate-x-full md:translate-x-0 w-full md:w-64 lg:w-80 transition-all duration-200 ease-in-out">
        <div class="flex-1 flex flex-col overflow-y-auto">
            <div class="md:hidden flex flex-row h-11 py-2 bg-accent">
                <NavbarIcon/>
            </div>
            <div @ref="_navbarRef" class="flex flex-row h-full overflow-y-hidden">
                <div class="flex flex-1 flex-col md:pt-0.5 pr-0.5 text-secondary bg-accent">
                    <NavbarShortcuts/>
                </div>
                <div class="flex flex-col w-full h-full overflow-y-auto pt-2 custom-scrollbar">
                    <div class="hidden md:flex flex-row flex-nowrap justify-center">
                        <NavbarLogo />
                    </div>
                    <div class="h-9/10 overflow-y-auto custom-scrollbar my-3 pl-4 pr-2 mr-2">
                        <NavbarLinks/>
                    </div>
                    @* Bottom sticky panel *@
                    <div class="flex flex-1 bottom-2 flex-col items-stretch">
                        <div class="text-xxs text-primary-muted w-auto h-auto block py-1 border-t-2 border-accent">
                            <span><b class="text-primary font-medium px-4">@version</b></span>
                        </div>
                        <div class="flex-col text-xxs text-primary-muted w-auto h-auto block mb-2 py-1 border-b-2 border-accent">
                            <div class="px-4">
                                <BlazorModeToggle/>
                            </div>
                        </div>
                        <div class="bg-primary flex flex-row justify-between items-center w-full px-4 h-12">
                            <AccountDropdown/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="flex-1 overflow-y-auto flex flex-col relative float-left">
        <div class="bg-secondary flex-1 overflow-y-auto">
            @if (failures.Count != 0) {
                <div class="flex flex-col absolute z-50 right-0 mr-2 mt-12 md:mt-2 w-4/5 md:w-1/4 overflow-y-auto">
                    @foreach (var failure in failures) {
                        <WhenCommandError
                            Error="failure.Result?.Error"
                            Dismissed="@(_ => _commandFailureList.Remove(failure.CommandId))"/>
                    }
                </div>
            }
            @Body
        </div>
    </div>
</div>

@code {
    private ElementReference _navbarRef;
    private IJSObjectReference _jsRef = null!;
    private DotNetObjectReference<INavbarBackend> _blazorRef = null!;

    protected override void OnInitialized() {
        _navigator.LocationChanged += OnLocationChanged;
        _commandFailureList.Changed += OnCommandFailureListChanged;
    }

    public void Dispose() {
        _navigator.LocationChanged -= OnLocationChanged;
        _commandFailureList.Changed -= OnCommandFailureListChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
        => _commandFailureList.Clear();

    private void OnCommandFailureListChanged()
        => InvokeAsync(StateHasChanged);

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _blazorRef = DotNetObjectReference.Create<INavbarBackend>(this);
            _jsRef = await _js.InvokeAsync<IJSObjectReference>(
                $"{BlazorUICoreModule.ImportName}.Navbar.create",
                _navbarRef, _blazorRef
                ).ConfigureAwait(true);
        }
    }
}
