@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager _navigator
@inject UICommandFailureList _commandFailureList

@{
    var failures = _commandFailureList.Items;
    var version = "v" + (GetType().Assembly.GetInformationalVersion() ?? "n/a").Replace('+', ' ');
}
<NavbarIcon />
<div class="flex-1 flex flex-row justify-items-stretch h-full max-h-full overflow-y-hidden relative bg-primary">
    <input id="navbar-toggle" class="hidden" type="checkbox" />
    <nav id="navbar-links" class="bg-primary text-primary z-50 absolute top-0 left-0 h-full md:static flex flex-col justify-between transform translate-x-full md:translate-x-0 w-full md:w-64 lg:w-80 transition duration-200 ease-in-out p-3">
        <div class="flex-1 flex flex-col overflow-y-auto">
            <div class="hidden md:flex flex-row flex-nowrap justify-center">
                <NavbarLogo />
            </div>
            <NavbarIcon/>
            <div class="flex-1 flex flex-col overflow-y-auto">
                <NavbarLinks />
            </div>
        </div>
        @* Bottom sticky panel *@
        <div class="flex flex-col sticky items-stretch">
            <div class="text-xxs text-primary-muted w-auto h-auto block pb-1">
                <span><b class="text-primary font-medium border-b border-accent">@version</b></span>
                <br/>
            </div>
            <div class="text-xxs text-primary-muted w-auto h-auto block pb-1">
                <BlazorModeToggle />
                <br/>
                <MediaRecorderToggle />
            </div>
            <div class="bg-primary flex flex-row justify-between items-center w-full pt-2 border-t border-accent">
                <AccountDropdown />
            </div>
        </div>
    </nav>
    <div class="flex-1 overflow-y-auto flex flex-col relative">
        <div class="bg-secondary flex-1 overflow-y-auto">
            @foreach (var failure in failures) {
                <WhenCommandError
                    Error="failure.Result?.Error"
                    Dismissed="@(_ => _commandFailureList.Remove(failure.CommandId))" />
            }
            @Body
        </div>
    </div>
</div>

@code {
    protected override void OnInitialized() {
        _navigator.LocationChanged += OnLocationChanged;
        _commandFailureList.Changed += OnCommandFailureListChanged;
    }

    public void Dispose() {
        _navigator.LocationChanged -= OnLocationChanged;
        _commandFailureList.Changed -= OnCommandFailureListChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
        => _commandFailureList.Clear();

    private void OnCommandFailureListChanged()
        => InvokeAsync(StateHasChanged);
}
