@using Microsoft.Toolkit.HighPerformance
@using ActualChat.UI.Blazor.Services
@using ActualChat.Media
@namespace ActualChat.UI.Blazor.Components

@{
    var sizeClass = $"pic-size-{(int)Size}";
    var cursorClass = EnableImagePreview || Click.HasDelegate ? "pic-show-cursor" : "";
}

<div class="@Class @sizeClass">
    @if (_hasPicture) {
        <img class="pic-image @sizeClass @cursorClass"
             alt=""
             src="@_pictureUrl"
             @onclick="@OnPictureClick"
             @onclick:preventDefault="true"/>
    } else if(NoPicture != null) {
        @NoPicture
    } else {
        <div class="pic-generated @sizeClass"
             style="@_picStyle">
            @((Title.NullIfEmpty() ?? " ")[..1])
        </div>
    }
</div>

@code {
    private string _picStyle = "";
    private string _pictureUrl = "";
    private bool _hasPicture;

    [Inject] private UrlMapper UrlMapper { get; init; } = null!;
    [Inject] private VisualMediaViewerUI VisualMediaViewerUI { get; init; } = null!;

    [Parameter] public string Class { get; set; } = "";
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public MediaContent? MediaContent { get; set; }
    [Parameter] public string ExternalPictureUrl { get; set; } = "";
    [Parameter] public SquareSize Size { get; set; } = SquareSize.Size10;
    [Parameter] public bool EnableImagePreview { get; set; }
    [Parameter] public RenderFragment? NoPicture { get; set; }
    [Parameter] public EventCallback<MouseEventArgs> Click { get; set; }

    protected override void OnParametersSet() {
        _pictureUrl = "";
        if (MediaContent != null) {
            _pictureUrl = UrlMapper.ImagePreview128Url(UrlMapper.ContentUrl(MediaContent.ContentId));
            _hasPicture = true;
        } else if (!ExternalPictureUrl.IsNullOrEmpty()) {
            _pictureUrl = UrlMapper.ImagePreview128Url(ExternalPictureUrl);
            _hasPicture = true;
        } else {
            _picStyle = $"background-color: {GenerateColor()}";
        }
    }

    private string GenerateColor() {
        var hash = Title.GetDjb2HashCode();
        var h = hash % 360;
        return $"hsl({h}, 30%, 80%)";
    }

    private async Task OnPictureClick(MouseEventArgs arg) {
        await Click.InvokeAsync(arg).ConfigureAwait(false);

        if (EnableImagePreview) {
            var url = UrlMapper.ContentUrl(MediaContent!.ContentId);
            await VisualMediaViewerUI.Show(url);
        }
    }
}
