@namespace ActualChat.UI.Blazor.Components
@using ActualChat.Users
@using ActualChat.UI.Blazor.Services;
@inherits ComputedStateComponent<AccountFull>

@{
    var account = State.Value;
    if (ReferenceEquals(account, AccountFull.Loading)) // Not yet loaded
        return;
    if (ChildContent == null)
        return;
    if (!_renderedContent && _navigated)
        return;
    _renderedContent = true;
}

@ChildContent

@code {
    private AccountFull? _lastAccount;
    private bool _navigated;
    private bool _renderedContent;

    [Inject] private Session Session { get; init; } = null!;
    [Inject] private AccountUI AccountUI { get; init; } = null!;
    [Inject] private AutoNavigationUI AutoNavigationUI { get; init; } = null!;
    [Inject] private NavigationManager Nav { get; init; } = null!;

    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public bool NavigateIfAlreadySignedIn { get; set; }

    protected override void OnInitialized() {
        base.OnInitialized();
        var account = State.Value;
        HandleAccountChanges(account);
    }

    protected override ComputedState<AccountFull>.Options GetStateOptions()
        => new () {
            UpdateDelayer = FixedDelayer.Instant,
            Category = GetStateCategory(),
            InitialValue = AccountUI.OwnAccount.Value
        };

    protected override async Task<AccountFull> ComputeState(CancellationToken cancellationToken) {
        var account = await AccountUI.OwnAccount.Use(cancellationToken);
        HandleAccountChanges(account);
        return account;
    }

    private void HandleAccountChanges(AccountFull account)
    {
        _lastAccount ??= account;

        var isSignedIn = !account.IsGuestOrNone;
        var wasSignedIn = !_lastAccount.IsGuestOrNone;
        _lastAccount = account;

        if (isSignedIn && (NavigateIfAlreadySignedIn || !wasSignedIn)) {
            if (!_navigated && AutoNavigationUI.TryNavigateToChatsOnSignIn())
                _navigated = true;
        }
    }
}
