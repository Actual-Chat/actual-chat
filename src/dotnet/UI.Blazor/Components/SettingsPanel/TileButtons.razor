@namespace ActualChat.UI.Blazor.Components
@using ActualChat.Users
@using ActualChat.UI.Blazor.Services
@inherits ComputedStateComponent<bool>
@{
    var m = State.Value;
    var cls = m ? "text-primary" : "text-icons-01";
}

@if (!HideSetDefaultButton) {
    <ButtonRound
        Class="btn-sm transparent"
        Tooltip="Set default"
        TooltipPosition="FloatingPosition.Top"
        Click="@OnSetDefaultClick">
        <i class="icon-star text-xl @cls"></i>
    </ButtonRound>
}
@if (!HideEditButton) {
    <ButtonRound
        Class="btn-sm transparent tile-btn"
        Tooltip="Edit"
        TooltipPosition="FloatingPosition.Top"
        Click="OnEditClick">
        <i class="icon-edit text-xl"></i>
    </ButtonRound>
}
@if (!HideCloseButton) {
    <ButtonRound
        Class="btn-sm transparent"
        Tooltip="Close"
        TooltipPosition="FloatingPosition.Top"
        Click="@OnCloseClick">
        <i class="icon-close text-xl @cls"></i>
    </ButtonRound>
}

@code{
    [Inject] private IAvatars Avatars { get; init; } = null!;
    [Inject] private AccountSettings AccountSettings { get; init; } = null!;
    [Inject] private Session Session { get; init; } = null!;

    [Parameter] public bool HideEditButton { get; set; } = true;
    [Parameter] public bool HideSetDefaultButton { get; set; } = true;
    [Parameter] public bool HideCloseButton { get; set; } = true;
    [Parameter] public AvatarFull Avatar { get; set; } = AvatarFull.None;
    [Parameter] public EventCallback OnEditClick { get; set; }
    [Parameter] public EventCallback OnSetDefaultClick { get; set; }
    [Parameter] public EventCallback OnCloseClick { get; set; }

    protected override ComputedState<bool>.Options GetStateOptions()
        => new() {
            UpdateDelayer = FixedDelayer.Instant,
            Category = GetStateCategory(),
        };

    protected override async Task<bool> ComputeState(CancellationToken cancellationToken) {
        var accountSettings = await AccountSettings.GetUserAvatarSettings(cancellationToken);
        var defaultAvatarId = accountSettings.DefaultAvatarId;
        if (defaultAvatarId.IsEmpty)
            defaultAvatarId = accountSettings.AvatarIds.FirstOrDefault();
        return Avatar.Id == defaultAvatarId;
    }

}
