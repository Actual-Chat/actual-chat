@using ActualChat.UI.Blazor.Module
@using ActualChat.UI.Blazor.Components.SideNav
@implements IAsyncDisposable

<div @ref="ElementRef" class="side-nav @Class">
    <div class="side-nav-drawer"></div>
    @ChildContent
</div>

@code {
    [Inject] private IJSRuntime JS { get; init; } = null!;

    [Parameter] public SideNavDirection Direction { get; set; } = SideNavDirection.LeftToRight;
    [Parameter] public bool IsHidden { get; set; } = false;
    [Parameter] public bool IsOpened { get; set; } = false;
    [Parameter] public EventCallback Closed { get; set; }
    [Parameter] public EventCallback Opened { get; set; }
    [Parameter] public RenderFragment ChildContent { get; set; } = null!;

    private string Class { get; set; } = "";

    private ElementReference ElementRef { get; set; }
    private IJSObjectReference JSRef { get; set; } = null!;
    private DotNetObjectReference<SideNav> BlazorRef { get; set; } = null!;

    protected override void OnParametersSet() {
        Class = Direction == SideNavDirection.LeftToRight ? "side-nav-left" : "side-nav-right";
        if (IsHidden)
            Class += " side-nav-hidden";
        if (IsOpened)
            Class += " side-nav-opened";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            BlazorRef = DotNetObjectReference.Create(this);
            var identifier = $"{BlazorUICoreModule.ImportName}.SideNav.create";
            var options = new SideNavOptions {
                Direction = Direction,
            };
            JSRef = await JS.InvokeAsync<IJSObjectReference>(
                identifier,
                ElementRef,
                BlazorRef,
                options).ConfigureAwait(true);
        }
    }

    public async ValueTask DisposeAsync() {
        await JSRef.DisposeSilentlyAsync("dispose").ConfigureAwait(true);
        JSRef = null!;
        BlazorRef.DisposeSilently();
        BlazorRef = null!;
    }

    [JSInvokable]
    public Task OnClosed() => Closed.InvokeAsync();

    [JSInvokable]
    public Task OnOpened() => Opened.InvokeAsync();
}
