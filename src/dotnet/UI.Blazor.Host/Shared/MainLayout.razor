@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager _navigator
@inject UICommandFailureList _commandFailureList

@{
    var failures = _commandFailureList.Items;
}

<TopBar />
@foreach (var failure in failures)
{
    <WhenCommandError Error="failure.Result?.Error"
                  Dismissed="@(_ => _commandFailureList.Remove(failure.CommandId))" />
}

@Body

@code {

    protected override void OnInitialized()
    {
        _navigator.LocationChanged += OnLocationChanged;
        _commandFailureList.Changed += OnCommandFailureListChanged;
    }

    public void Dispose()
    {
        _navigator.LocationChanged -= OnLocationChanged;
        _commandFailureList.Changed -= OnCommandFailureListChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
        => _commandFailureList.Clear();

    private void OnCommandFailureListChanged()
        => InvokeAsync(StateHasChanged);
}
