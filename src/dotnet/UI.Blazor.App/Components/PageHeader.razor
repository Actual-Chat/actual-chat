@using ActualChat.Chat.UI.Blazor.Services
@inherits ComputedStateComponent<PageHeader.Model>
@{
    var m = State.Value;
    var title = "Actual Chat";
    if (m.Count > 0)
        title += " (" + m.Count + ")";
}

<PageTitle>@title</PageTitle>
<HeadContent>
    @{
        var iconHref = m.Count > 0 ? "/unreadcountfavicon/+.svg" : "/unreadcountfavicon/0.svg";
    }
    @*
    Chrome sometimes does not react on svg icon link changes.
    Apparently it can be connected to issue https://bugs.chromium.org/p/chromium/issues/detail?id=1162276
    We can try to use png icons as workaround.
    *@
    <link rel="icon" href="@iconHref" type="image/svg+xml">
</HeadContent>

@code {
    [Inject] private ChatListUI ChatListUI { get; init; } = null!;

    protected override ComputedState<Model>.Options GetStateOptions() {
        return new() {
            InitialValue = new(),
            UpdateDelayer = FixedDelayer.Instant,
            Category = GetStateCategory(),
        };
    }

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var count = await ChatListUI.UnreadChatsCount.Use(cancellationToken);
        return new Model(count);
    }

    public sealed record Model(Trimmed<int> Count = default);
}
