@page "/"
@using ActualChat.Chat.UI.Blazor.Services
@using ActualChat.Users
@inherits ComputedStateComponent<HomePage.Model>
@layout NoLayout
@{
    var m = State.LatestNonErrorValue;
    var account = m.Account;
    if (account == null)
        return; // Not yet computed
    if (ReferenceEquals(account, Account.Guest)) { // Computed, account is null substituted to Account.Guest
        <Welcome/>
    }
    else if (!m.DefaultChatId.IsEmpty) {
        Nav.NavigateTo(Links.ChatPage(m.DefaultChatId));
    }
}

@code {
    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IAccounts Accounts { get; init; } = null!;
    [Inject] private RecentChats RecentChats { get; init; } = null!;
    [Inject] private ChatUI ChatUI { get; init; } = null!;
    [Inject] private NavigationManager Nav { get; init; } = null!;

    protected override async Task OnInitializedAsync() {
        var activeChatIdState = ChatUI.ActiveChatId;
        await activeChatIdState.WhenRead.ConfigureAwait(true);
    }

    protected override ComputedState<Model>.Options GetStateOptions() {
        return new() { InitialValue = new Model(null, Symbol.Empty) };
    }

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var account = await Accounts.Get(Session, CancellationToken.None).ConfigureAwait(false) ?? Account.Guest;
        var chat = await RecentChats.GetActiveChatOrDefault(cancellationToken).ConfigureAwait(false);
        return new(account, chat?.Id ?? Symbol.Empty);
    }

    public record Model(Account? Account, Symbol DefaultChatId);
}
