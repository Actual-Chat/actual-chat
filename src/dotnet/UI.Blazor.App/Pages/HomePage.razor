@page "/"
@using ActualChat.Chat.UI.Blazor.Services
@using ActualChat.UI.Blazor.Services
@using ActualChat.Users
@inherits ComputedStateComponent<HomePage.Model>
@layout NoLayout
@{
    var m = State.LatestNonErrorValue;
    var account = m.Account;
    if (ReferenceEquals(account, AccountFull.Loading)) // Not yet loaded
        return;
    if (ReferenceEquals(account, AccountFull.None)) { // Loaded, but user doesn't have an account
        _signInHasRequested = true;
        if (_enableIncompleteUI) {
            <Landing/>
        } else {
            <Welcome/>
        }
        return;
    }

    // Logged in
    if (!m.Link.IsNullOrEmpty() && !_navigated) {
        _navigated = true; // prevents multiple calls
        // Do automatic redirect on first load.
        Nav.NavigateTo(m.Link, false, true);
    }
}

@code {
    private bool _navigated;
    private bool _signInHasRequested;
    private bool _enableIncompleteUI;

    [Inject] private Session Session { get; init; } = null!;
    [Inject] private BrowserInfo BrowserInfo { get; init; } = null!;
    [Inject] private IAccounts Accounts { get; init; } = null!;
    [Inject] private ChatUI ChatUI { get; init; } = null!;
    [Inject] private HistoryUI HistoryUI { get; init; } = null!;
    [Inject] private LoadingUI LoadingUI { get; init; } = null!;
    [Inject] private Features Features { get; init; } = null!;
    [Inject] private NavigationManager Nav { get; init; } = null!;

    protected override Task OnInitializedAsync() => ChatUI.SelectedChatId.WhenRead;

    protected override ComputedState<Model>.Options GetStateOptions() {
        return new() { InitialValue = Model.Loading };
    }

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        _enableIncompleteUI = await Features.Get<UIFeatures.EnableIncompleteUI, bool>(cancellationToken);
        var account = await Accounts.GetOwn(Session, CancellationToken.None).ConfigureAwait(false);
        var link = "";
        if (HistoryUI.IsInitialLocation || _signInHasRequested) {
            if (BrowserInfo.ScreenSize.Value.IsNarrow())
                link = Links.Chat(default);
            else {
                var selectedChatId = await ChatUI.SelectedChatId.Use(cancellationToken).ConfigureAwait(false);
                var selectedChat = await ChatUI.Get(selectedChatId, cancellationToken).ConfigureAwait(false);
                link = Links.Chat(selectedChat != null ? selectedChatId : Constants.Chat.AnnouncementsChatId);
            }
        }
        return new(account, link);
    }

    protected override void OnAfterRender(bool firstRender) {
        var m = State.LatestNonErrorValue;
        var account = m.Account;
        if (!ReferenceEquals(account, AccountFull.Loading))
            LoadingUI.MarkLoaded();
    }

    public record Model(AccountFull Account, string Link) {
        public static Model Loading { get; } = new(AccountFull.Loading, ""); // Should differ by ref. from None
    }
}
