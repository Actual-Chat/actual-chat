@namespace ActualChat.Chat.UI.Blazor.Components
@inherits ComputedStateComponent<ChatSettings.Model>
@{
    var m = State.LatestNonErrorValue;
}

<div class="flex-y text-secondary">
    <div class="flex-x flex-nowrap justify-start items-center mt-1">
        <i class="fa fa-bell mr-2" aria-hidden="true"></i>
        <div class="text-sm font-medium text-secondary mr-2">Notifications</div>
        <ChatNotificationToggle ChatId="@Chat.Id"/>
    </div>
    @if (m.CanEdit) {
        <div class="mt-3 mb-4 h-0 border-b bg-primary"></div>
        <ChatMainProps/>
    }
    @if (m.CanInvite) {
        <div class="mt-3 mb-4 h-0 border-b bg-primary"></div>
        <ChatInviteProps />
    }
    <div class="mt-3 h-0 border-b bg-primary"></div>
</div>

@code {
    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IChats Chats { get; init; } = null!;
    [CascadingParameter] public Chat Chat { get; set; } = null!;

    protected override ComputedState<Model>.Options GetStateOptions()
        => new() { InitialValue = Model.None };

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var permissions = await Chats.GetPermissions(Session, Chat.Id, default);
        var canEdit = permissions.HasFlag(ChatPermissions.Admin);
        var canInvite = permissions.HasFlag(ChatPermissions.Invite);
        return new Model(canEdit, canInvite);
    }

    public sealed record Model(bool CanEdit, bool CanInvite) {
        public static Model None { get; } = new(false, false);
    };
}
