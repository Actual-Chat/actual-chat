@namespace ActualChat.Chat.UI.Blazor.Components
@using System.ComponentModel.DataAnnotations

<EditForm Model="@_model" OnValidSubmit="@OnSave">
    <DataAnnotationsValidator/>

    <div class="flex-x items-center">
        <label for="ChatTitle" class="block text-sm font-medium text-secondary">Chat title</label>
        <div class="ml-4 grow">
            <TextBox @bind-Value="@_model.Title" id="ChatTitle"
                     class="input-underlined w-full focus:outline-none focus:border-sky-500"/>
        </div>
    </div>

    <div class="mt-3">
        <label for="ChatType" class="block text-sm font-medium text-secondary">Chat type</label>
        <InputRadioGroup @bind-Value="_model.IsPublic" id="ChatType">
            <InputRadio Value="@true"/><text>&nbsp;</text>Public chat<br>
            <InputRadio Value="@false"/><text>&nbsp;</text>Private chat<br>
        </InputRadioGroup>
    </div>

    <div class="mt-3 flex-x justify-end">
        <Button Type="@ButtonType.Submit" Disabled="@(!context.Validate())">Save</Button>
    </div>
</EditForm>


@code {
    private Chat? _chat;
    private readonly ChatPropsEditModel _model = new();

    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IChats Chats { get; init; } = null!;
    [Inject] private UICommandRunner Cmd { get; init; } = null!;

    [CascadingParameter] public Chat Chat { get; set; } = null!;

    protected override Task OnParametersSetAsync() {
        _chat = Chat;
        _model.Title = _chat.Title;
        _model.IsPublic = _chat.IsPublic;
        return Task.CompletedTask;
    }

    private async Task OnSave() {
        var modifiedChat = Chat with {
            Title = _model.Title,
            IsPublic = _model.IsPublic
        };
        var command = new IChats.UpdateChatCommand(Session, modifiedChat);
        var (_, cmdEvent) = await Cmd.Run(command);
    }

    public class ChatPropsEditModel
    {
        [Required]
        public string Title { get; set; } = "";
        public bool IsPublic { get; set; }
    }
}
