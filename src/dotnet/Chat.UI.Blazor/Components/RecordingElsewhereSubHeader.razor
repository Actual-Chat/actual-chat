@inherits ComputedStateComponent<RecordingElsewhereSubHeader.Model>
@namespace ActualChat.Chat.UI.Blazor.Components
@using ActualChat.Chat.UI.Blazor.Services
@using ActualChat.MediaPlayback
@{
    var m = State.ValueOrDefault;
    if (m?.RecordingChat == null)
        return;
}

<div class="recording-elsewhere-sub-header">
    <div class="recording-elsewhere-sub-header-content">
        <div class="c-icons">
            <i class="icon-mic text-2xl"></i>
        </div>
        <div class="c-text shrink-0">
            Recording in
        </div>
        <a class="inline-block c-text truncate" href="@m.RecordingChatUrl">@(m.RecordingChat.Title)</a>
        <div class="c-text">chat!</div>
    </div>
</div>

@code {
    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IAccounts Accounts { get; init; } = null!;
    [Inject] private IChats Chats { get; init; } = null!;
    [Inject] private ChatUI ChatUI { get; init; } = null!;

    [CascadingParameter] public Chat Chat { get; set; } = null!;

    protected override ComputedState<Model>.Options GetStateOptions()
        => new() {
            InitialValue = Model.None,
            UpdateDelayer = FixedDelayer.Instant,
        };

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        if (await ChatUI.IsRecording(Chat.Id))
            return Model.None;

        var recordingChatId = await ChatUI.GetRecordingChatId();
        if (recordingChatId.IsNone)
            return Model.None;

        var recordingChat = await Chats.Get(Session, recordingChatId, cancellationToken);
        if (recordingChat == null)
            return Model.None;

        if (recordingChat.Kind == ChatKind.Group)
            return new Model {
                RecordingChat = recordingChat,
                RecordingChatUrl = Links.ChatPage(recordingChat.Id),
            };

        return new Model {
            RecordingChat = recordingChat,
            RecordingChatUrl = Links.ChatPage(recordingChatId),
        };
    }

    private void OnStop()
        => _ = ChatUI.SetRecordingChatId(default);

    public sealed record Model {
        public static Model None { get; } = new();

        public Chat? RecordingChat { get; init; }
        public string? RecordingChatUrl { get; init; }
    }
}
