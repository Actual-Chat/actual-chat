<div class="chat-message-modal inline">
    <div class="bg-primary p-5 h-screen md:h-auto">
        @if (RequestAuthor.Id == Model.Entry.AuthorId) {
            <div class="modal-subtitle relative flex-x text-sm mb-2 min-h-8">
                Are you sure you want to delete this message?
            </div>
            <div class="modal-body">
                <div class="w-full">
                    <div class="chat-message group px-1">
                        <ChatAuthorBadge AuthorId="@Model.Entry.AuthorId">
                            <div class="relative author-badge w-9 h-9 mx-1.5 mt-1.5 select-none bg-secondary rounded-md">
                                <img src="@context.Author.Picture" alt="@context.Author.Name" class="block"/>
                            </div>
                        </ChatAuthorBadge>
                        <div class="flex-1">
                            <div class="header chat-message-header ml-1">
                                <ChatAuthorBadge AuthorId="@Model.Entry.AuthorId">
                                    <span class="font-bold text-secondary rounded">@context.Author.Name</span>
                                </ChatAuthorBadge>
                                <ChatMessageTimestamp Value="Model.Entry.BeginsAt"/>
                            </div>
                            <div class="content message-content rounded-sm ml-1">
                                @if (Model.Attachments.Length > 0) {
                                    var attachment = Model.Attachments[0];
                                    var isImage = attachment.ContentType.StartsWith("image", StringComparison.OrdinalIgnoreCase);
                                    @if (isImage) {
                                        <ImageAttachment Attachment="@attachment"/>
                                    } else {
                                        <FileAttachment Attachment="@attachment"/>
                                    }
                                }
                                <CascadingValue Value="@Model.Entry">
                                    <MarkupView Markup="@Model.Markup"/>
                                </CascadingValue>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="-flex-x gap-x-2 bottom-0 right-5 absolute md:static bg-primary w-full py-4 md:p-0 min-h-24 md:min-h-0">
                <Button Class="btn-error" OnClick="OnDelete">Delete</Button>
                <Button Class="btn-primary" OnClick="OnCancel" Focus="true">Cancel</Button>
            </div>
        } else {
            <div class="flex-x font-light text-sm mb-2">
                You can't delete this message.
            </div>
            <div class="-flex-x gap-x-2 absolute bottom-0 right-5 md:static bg-primary w-full py-4 md:p-0 min-h-24 md:min-h-0">
                <Button Class="btn-primary" OnClick="OnCancel" Focus="true">Close</Button>
            </div>
        }
    </div>
</div>

@code {
    private string Message { get; set; } = "";

    [Inject] private IChatAuthors ChatAuthors { get; set; } = null!;
    [Inject] private IChats Chats { get; set; } = null!;
    [Inject] private Session Session { get; set; } = null!;
    [Inject] private UICommandRunner Cmd { get; set; } = null!;
    [Inject] private NavigationManager Nav { get; set; } = null!;
    [Inject] private FeedbackUI FeedbackUI { get; set; } = null!;

    [CascadingParameter]
    BlazoredModalInstance ModalInstance { get; set; } = null!;

    [Parameter, EditorRequired, ParameterComparer(typeof(ByValueParameterComparer))]
    public ChatMessageModel Model { get; set; } = null!;

    [Parameter] public ChatAuthor RequestAuthor { get; set; } = null!;

    private void OnCancel() {
        ModalInstance.CloseAsync(ModalResult.Cancel());
    }

    private async Task OnDelete() {
        await ModalInstance.CloseAsync(ModalResult.Cancel());
        await FeedbackUI.AskFeatureRequestFeedback("message-menu/delete-message", "Delete Message");
    }

    public override Task SetParametersAsync(ParameterView parameters)
        => this.HasChangedParameters(parameters) ? base.SetParametersAsync(parameters) : Task.CompletedTask;

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        InitMessage();
    }

    private void InitMessage()
    {
        var markup = Model.Markup;
        Message = markup.ToString();
    }

}
