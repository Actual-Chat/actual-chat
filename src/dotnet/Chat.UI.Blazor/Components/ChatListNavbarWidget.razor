@inherits ComputedStateComponent<ChatListNavbarWidget.Model>
@{
    var m = State.LatestNonErrorValue ?? Model.None;

    RenderFragment RenderItem(Chat c) =>
        @<NavbarItem Url="@($"/chat/{c.Id}")" IsActive="@(m.ActiveChatId == c.Id)">
            <ChildContent>@c.Title</ChildContent>
            <Ending>
                <ChatListRecordingToggle ChatId="@c.Id"/>
                <ChatListPinToggle ChatId="@c.Id"/>
            </Ending>
        </NavbarItem>;
}

<NavbarGroup Title="Chats" Class="navbar-chats" Id="chats">
    <Icons>
        @if (m.CanCreateChat) {
            <ButtonSquare Title="Create new chat" Click="OnCreateNewChatClick">
                <i class="fa fa-plus fa-fw pt-0.5" aria-hidden="true"></i>
            </ButtonSquare>
        }
    </Icons>
    <ChildContent>
        @if (m.PinnedChats.Length > 0) {
            <NavbarSubgroup Class="first">Pinned</NavbarSubgroup>
            foreach (var c in m.PinnedChats)
                @RenderItem(c)
            if (m.UnpinnedChats.Length > 0) {
                <NavbarSubgroup>Unpinned</NavbarSubgroup>
                foreach (var c in m.UnpinnedChats)
                    @RenderItem(c)
            }
        } else {
            foreach (var c in m.UnpinnedChats)
                @RenderItem(c)
        }
    </ChildContent>
</NavbarGroup>

@code {
    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IUserProfiles UserProfiles { get; init; } = null!;
    [Inject] private IChats Chats { get; init; } = null!;
    [Inject] private ChatUI ChatUI { get; init; } = null!;
    [Inject] private ModalUI ModalUI { get; init; } = null!;

    protected override ComputedState<Model>.Options GetStateOptions()
        => new() {
            InitialValue = Model.None,
            UpdateDelayer = UpdateDelayer.MinDelay,
        };

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var userProfile = await UserProfiles.Get(Session, cancellationToken).ConfigureAwait(false);
        if (userProfile is not { Status: UserStatus.Active })
            return Model.None;

        var chats = await Chats.GetChats(Session, cancellationToken).ConfigureAwait(false);
        var mustAddDefaultChat = userProfile.IsAdmin && chats.All(c => c.Id != Constants.Chat.DefaultChatId);
        if (mustAddDefaultChat) {
            var defaultChat = await Chats.Get(Session, Constants.Chat.DefaultChatId, cancellationToken);
            if (defaultChat != null)
                chats = chats.Append(defaultChat).ToArray();
        }

        var activeChatId = await ChatUI.ActiveChatId.Use(cancellationToken).ConfigureAwait(false);
        var pinnedChatIds = await ChatUI.PinnedChatIds.Use(cancellationToken).ConfigureAwait(false);
        var pinnedChats = chats
            .Where(c => pinnedChatIds.Contains(c.Id))
            .OrderBy(c => c.Title)
            .ToArray();
        var unpinnedChats = chats
            .Where(c => !pinnedChatIds.Contains(c.Id))
            .OrderBy(c => c.Title)
            .ToArray();

        return new Model() {
            CanCreateChat = true,
            PinnedChats = pinnedChats,
            UnpinnedChats = unpinnedChats,
            ActiveChatId = activeChatId,
        };
    }

    private void OnCreateNewChatClick()
        => ModalUI.Show(new NewChatModal.Model());

    public sealed record Model {
        public static Model None { get; } = new();

        public bool CanCreateChat { get; init; }
        public Chat[] PinnedChats { get; init; } = Array.Empty<Chat>();
        public Chat[] UnpinnedChats { get; init; } = Array.Empty<Chat>();
        public Symbol ActiveChatId { get; init; }
    }
}
