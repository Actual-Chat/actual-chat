@implements IModalView<LeaveChatConfirmationModal.Model>

<DialogFrame Title="Leave chat">
    <Body>
        <p>Are you sure you want to leave this chat?</p>
    </Body>
    <Buttons>
        <div class="btn-group">
            <Button Class="btn-cancel" Click="OnCancel">Cancel</Button>
            <Button Class="btn-error" Click="OnLeave">Leave</Button>
        </div>
    </Buttons>
</DialogFrame>

@code {
    [Inject] private Session Session { get; init; } = null!;
    [Inject] private UICommander UICommander { get; init; } = null!;
    [Inject] private ChatUI ChatUI { get; init; } = null!;
    [Inject] private History History { get; init; } = null!;

    [CascadingParameter] public Modal Modal { get; set; } = null!;
    [Parameter] public Model ModalModel { get; set; } = null!;

    private void OnCancel()
        => Modal.Close();

    private async Task OnLeave(MouseEventArgs arg) {
        var isSelectedChat = ModalModel.Chat.Id.Equals(ChatUI.SelectedChatId.Value);
        var command = new IAuthors.LeaveCommand(Session, ModalModel.Chat.Id);
        var result = await UICommander.Run(command);
        if (!result.HasError) {
            Modal.Close();
            if (isSelectedChat && !ModalModel.Chat.IsPublic)
                _ = History.NavigateTo(Links.Chats);
        }
    }

    public sealed record Model(Chat Chat);
}
