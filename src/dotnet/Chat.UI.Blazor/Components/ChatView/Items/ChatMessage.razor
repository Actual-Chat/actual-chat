@namespace ActualChat.Chat.UI.Blazor.Components
@inherits ComputedStateComponent<ChatMessage.Model>
@using ActualChat.Hosting
@using Microsoft.AspNetCore.Components.Rendering
@using System.Diagnostics.CodeAnalysis
@{
    var m = _lastRenderedModel = State.LatestNonErrorValue;
    var message = _lastRenderedMessage = Message;
    var entry = message.Entry;

    // Flags
    var isSystem = entry.IsSystemEntry;
    var isReply = entry.RepliedEntryLocalId != null;
    var isReplyToOwnMessage = m.RepliedChatMessage?.Entry.AuthorId == entry.AuthorId;
    var showAuthor = !isSystem && (message.IsBlockStart || isReply);

    // Classes
    var systemClass = isSystem ? "system-entry" : "";
    var marginClass = message.IsBlockEnd ? "mb-3" : "mb-0";
    var ownMessageClass = m.OwnAuthorId == message.Entry.AuthorId ? "own-message" : "";
    var highlightClass = m.IsHighlighted ? "chat-message-highlighted" : "";
    var repliedClass = m.IsReplyTarget ? "replied-message" : "";
    var mentionClass = m.IsOwnAuthorMentioned && !isReplyToOwnMessage ? "mention" : "";
    var cls = $"{systemClass} {ownMessageClass} {mentionClass} {marginClass} {highlightClass} {repliedClass} message-wrapper";
}

@if (message.DateLine.HasValue) {
    <ChatMessageDateLine Date="@message.DateLine.GetValueOrDefault()"/>
}
@if (message.IsFirstUnread) {
    <Separator Title="new" Class="new-separator" TitleClass="new-separator-title"/>
}
@if (isSystem) {
    <div class="@cls">
        <div class="flex-y w-full">
            <div class="chat-message group px-1.5 py-1 relative">
                <div class="flex-1 overflow-hidden">
                    <div class="message-content rounded-sm">
                        <p class="chat-message-markup mx-1">
                            <CascadingValue Value="@entry" IsFixed="true">
                                <MarkupView Markup="@Markup"/>
                            </CascadingValue>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    return;
}

<div class="@cls"
     data-hover-menu="@(MenuRef.New<MessageHoverMenu>(Message.Entry.ChatId, Message.Key).ToString())"
     data-menu="@(MenuRef.New<MessageMenu>(Message.Entry.ChatId, Message.Key, "").ToString())"
     data-menu-trigger="@((MenuTriggers.LongClick | MenuTriggers.RightClick).Format())"
     data-menu-position="@(FloatingPosition.BottomStart.ToPositionString())"
     data-long-press-delay="500">
    <div class="flex-y w-full">
        <div class="chat-message group px-1.5 py-1 relative">
            @if (showAuthor) {
                <div class="m-1.5">
                    <ChatMessageAuthorCircle AuthorSid="@entry.AuthorId" Click="@OnAuthorClick"/>
                </div>
            } else {
                var timestamp = TimeZoneConverter.ToLocalTime(entry.BeginsAt).ToShortTimeString();
                <div class="w-10 mr-2 mt-1">
                    <span class="chat-message-timestamp-on-hover">@timestamp</span>
                </div>
            }
            <div class="flex-1 overflow-hidden">
                @if (showAuthor) {
                    <div class="flex-x items-baseline header chat-message-header ml-1">
                        <AuthorName AuthorSid="@entry.AuthorId" Class="chat-message-author-name" />
                        <LiveTimeDeltaText Class="chat-message-timestamp min-w-fit px-2" Moment="@entry.BeginsAt"/>
                        @* &nbsp; *@
                        @* <span class="text-02 opacity-20 text-xxs">id=@entry.Id</span> *@
                    </div>
                }
                <div class="message-content rounded-sm">
                    @if (isReply) {
                        <QuotedMessage Message="@m.RepliedChatMessage"/>
                    }
                    @if (entry.IsStreaming) {
                        <ChatMessageTranscript Model="@message" Class="mx-1" ShowEntryKind="@Message.ShowEntryKind" />
                    } else {
                        <p class="chat-message-markup mx-1">
                            <CascadingValue Value="@entry" IsFixed="true">
                                <MarkupView Markup="@Markup"/>
                            </CascadingValue>
                        </p>
                    }
                </div>
                @if (entry.Attachments.Length > 0) {
                    <div class="message-attachments mx-1">
                        @foreach (var attachment in entry.Attachments) {
                            @if (attachment.IsImage()) {
                                <ImageAttachment Attachment="@attachment" ChatEntry="@entry"/>
                            } else {
                                <FileAttachment Attachment="@attachment"/>
                            }
                        }
                    </div>
                }
                @if (entry.HasReactions) {
                    <MessageReactions ChatEntry="@entry" />
                }
            </div>
        </div>
    </div>

    @if (!message.IsQuote) {
        <div class="message-hover-menu-placement placement"></div>
    }
</div>

@code {
    private Model? _lastRenderedModel;
    private ChatMessageModel? _lastRenderedMessage;
    private Markup? _cachedMarkup;

    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IAuthors Authors { get; init; } = null!;
    [Inject] private IChats Chats { get; init; } = null!;
    [Inject] private ChatUI ChatUI { get; init; } = null!;
    [Inject] private TimeZoneConverter TimeZoneConverter { get; init; } = null!;
    [Inject] private IMarkupParser MarkupParser { get; init; } = null!;
    [Inject] private UIEventHub UIEventHub { get; init; } = null!;
    [Inject] private IJSRuntime JS { get; init; } = null!;

    private Markup Markup => _cachedMarkup ?? GetMarkup();
    private ChatEntryReader Reader => Chats.NewEntryReader(Session, Message.Entry.ChatId, ChatEntryKind.Text);

    [Parameter, EditorRequired] public ChatMessageModel Message { get; set; } = null!;

    protected override void OnParametersSet()
        => _cachedMarkup = null;

    protected override bool ShouldRender()
        => !(
            ReferenceEquals(_lastRenderedModel, State.LatestNonErrorValue)
            && ReferenceEquals(_lastRenderedMessage, Message));

    protected override ComputedState<Model>.Options GetStateOptions() {
        var initialValue = Model.None;
        var entry = Message.Entry;
        var chatId = entry.ChatId;
        var ownAuthorTask = Authors.GetOwn(Session, chatId, default);
        if (ownAuthorTask.IsCompletedSuccessfully) {
            var ownAuthorId = ownAuthorTask.Result?.Id ?? Symbol.Empty;
            initialValue = new Model { OwnAuthorId = ownAuthorId };
        }
        return new() { InitialValue = initialValue };
    }

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var entry = Message.Entry;
        var chatId = entry.ChatId;
        var ownAuthor = await Authors.GetOwn(Session, chatId, cancellationToken);
        var ownAuthorId = ownAuthor?.Id ?? Symbol.Empty;

        var repliedMessage = await GetRepliedChatMessage(cancellationToken);
        var hasAnyMentions = HasAnyMentions(Markup);
        var isOwnAuthorMentioned = IsMentioned(Markup, repliedMessage, ownAuthorId, hasAnyMentions);
        var isReplyTarget = entry == (await ChatUI.LinkedChatEntry.Use(cancellationToken))?.Entry;
        var isHighlighted = entry.Id.LocalId == await ChatUI.HighlightedChatEntryId.Use(cancellationToken);
        var result = new Model {
            OwnAuthorId = ownAuthorId,
            RepliedChatMessage = repliedMessage,
            IsHighlighted = isHighlighted,
            IsReplyTarget = isReplyTarget,
            IsOwnAuthorMentioned = isOwnAuthorMentioned,
        };
        return result.Equals(_lastRenderedModel) ? _lastRenderedModel! : result;
    }

    private Markup GetMarkup() {
        var entry = Message.Entry;
        var isQuote = Message.IsQuote;
        var content = entry.Content;
        var markup = entry switch {
            { SystemEntry: { } se } => new SystemMarkup(MarkupParser.Parse(se.Option?.ToMarkup() ?? "")),
            { IsAudioEntry: true } when !isQuote => new PlayableTextMarkup(content, entry.TextToTimeMap),
            { IsAudioEntry: true } when isQuote => new PlainTextMarkup(content),
            _ => MarkupParser.Parse(content),
        };
        return markup;
    }

    private async Task<ChatMessageModel?> GetRepliedChatMessage(CancellationToken cancellationToken) {
        if (Message.Entry.RepliedEntryLocalId is not { } repliedEntryLocalId)
            return null;

        var repliedEntryId = new ChatEntryId(Message.Entry.ChatId, Message.Entry.Kind, repliedEntryLocalId, AssumeValid.Option);
        var repliedEntry = await Reader.Get(repliedEntryLocalId, CancellationToken.None)
            ?? ChatEntry.Removed(repliedEntryId);

        return new ChatMessageModel(repliedEntry) {
            IsBlockStart = true,
            IsQuote = true,
        };
    }

    private void OnAuthorClick()
        => ChatUI.ShowAuthorModal(Message.Entry.AuthorId);

    private async Task OnQuoteClick() {
        if (Message.IsQuote) {
            await UIEventHub.Publish(new NavigateToChatEntryEvent(Message.Entry.Id));
            ChatUI.HighlightedChatEntryId.Value = Message.Entry.LocalId;
        }
    }

    private bool HasAnyMentions(Markup markup)
        => MarkupValidator.ContainsAnyMention.IsValid(markup);

    private bool IsMentioned(Markup markup,
        ChatMessageModel? repliedChatMessage,
        Symbol authorId,
        bool hasAnyMentions)
    {
        if (authorId.IsEmpty)
            return false;

        if (repliedChatMessage?.Entry.AuthorId == authorId)
            return true;

        return hasAnyMentions && MarkupValidator.ContainsMention($"a:{authorId}").IsValid(markup);
    }

    // Nested types

    public sealed record Model {
        public static readonly Model None = new();

        public Symbol OwnAuthorId { get; init; }
        public ChatMessageModel? RepliedChatMessage { get; init; }
        public bool IsHighlighted { get; init; }
        public bool IsReplyTarget { get; init; }
        public bool IsOwnAuthorMentioned { get; init; }
    }
}
