@namespace ActualChat.Chat.UI.Blazor.Components
@inherits ComputedStateComponent<ChatMenuContent.Model>
@using BlazorContextMenu
@{
    var m = State.LatestNonErrorValue;
}

@if (m.CanRecord) {
    <ChatMenuRecord/>
}
<ChatMenuPin/>
<ChatMenuListen/>
@if (m.CanLeave) {
    <BlazorContextMenu.Separator/>
    <ChatMenuLeave/>
}

@code{
    [Inject] private IChats Chats { get; init; } = null!;
    [Inject] private Session Session { get; init; } = null!;

    [CascadingParameter] public Chat Chat { get; set; } = null!;

    protected override ComputedState<Model>.Options GetStateOptions() {
        return new ComputedState<Model>.Options() {
            InitialValue = Model.None
        };
    }

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var rules = await Chats.GetRules(Session, Chat.Id, cancellationToken).ConfigureAwait(false);
        // Default scheduler is used from here
        var canLeave = rules.CanLeave();
        var canRecord = rules.CanWrite();
        return new Model {
            CanLeave = canLeave,
            CanRecord = canRecord
        };
    }

    public sealed record Model {
        public static readonly Model None = new Model();

        public bool CanLeave { get; init; }
        public bool CanRecord { get; init; }
    }
}
