@namespace ActualChat.Chat.UI.Blazor.Components
@using ActualChat.Users.UI.Blazor.Services
@inherits ComputedStateComponent<CreationPanelContacts.Model>

@{
    var m = State.LatestNonErrorValue;

    RenderFragment RenderTab(TabId tabId, string title) =>
        @<Tab
             Title="@title" Id="@tabId.ToString()"
             Class="flex-y self-start relative overflow-y-auto custom-scrollbar h-full contacts-tab">
            <div class="h-full flex-y my-2">
                <ContactList Contacts="m.PinnedContacts" Kind="ContactListKind.Pinned"/>
                <ContactList Contacts="m.UnpinnedContacts" Kind="ContactListKind.Unpinned"/>
            </div>
        </Tab>;
}

<TabPanel
    BottomHill="true"
    Class="overflow-y-hidden"
    TabsClass="left-panel-tabs"
    ActiveTabChanged="OnActiveTabChanged">

    @RenderTab(TabId.Recent, "Recent")
    @RenderTab(TabId.All, "A-Z")
</TabPanel>

@code{
    private TabId _activeTabId;

    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IAccounts Accounts { get; init; } = null!;
    [Inject] private IContacts Contacts { get; init; } = null!;
    [Inject] private ChatUI ChatUI { get; init; } = null!;
    [Inject] private SearchUI SearchUI { get; init; } = null!;
    [Inject] private IRecentEntries RecentEntries { get; init; } = null!;

    protected override ComputedState<Model>.Options GetStateOptions()
        => new() {
            InitialValue = Model.None,
            UpdateDelayer = FixedDelayer.Instant,
        };

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var account = await Accounts.GetOwn(Session, cancellationToken);
        if (!account.IsActive())
            return Model.None;

        var contacts = await ListContacts(_activeTabId, cancellationToken);
        var searchPhrase = await SearchUI.GetSearchPhrase(cancellationToken);
        if (!searchPhrase.IsEmpty) {
            var selectedChatId = await ChatUI.SelectedChatId.Use(cancellationToken);
            var activeContactId = GetContactId(selectedChatId);
            contacts = (
                from contact in contacts
                let rank = searchPhrase.GetMatchRank(contact.Avatar.Name)
                where rank > 0 || contact.TargetUserId == activeContactId
                orderby rank descending
                select contact
                ).ToList();
        }

        var pinnedChatIds = await ChatUI.PinnedChats.Use(cancellationToken);
        var pinnedContacts = contacts
            .Where(c => pinnedChatIds.Contains(c.GetFullPeerChatId()))
            .ToList();
        var unpinnedContacts = contacts
            .Where(c => !pinnedChatIds.Contains(c.GetFullPeerChatId()))
            .ToList();

        return new Model {
            PinnedContacts = pinnedContacts,
            UnpinnedContacts = unpinnedContacts,
        };

        Symbol GetContactId(string chatId) {
            var targetUserId = ParsedChatId.TryParse(chatId, out var parsedChatId)
                ? parsedChatId.GetPeerChatTargetUserId(account.User.Id)
                : Symbol.Empty;
            return contacts.All(c => c.TargetUserId != targetUserId)
                ? Symbol.Empty
                : // No active contact in the current group
                targetUserId;
        }
    }

    private async Task<List<Contact>> ListContacts(TabId tabId, CancellationToken cancellationToken) {
        var contacts = await Contacts.ListOwn(Session, cancellationToken);
        return tabId switch {
            TabId.All => contacts.ToList(),
            TabId.Recent => await RecentEntries
                .OrderByRecency(Session, contacts, RecencyScope.Contact, Constants.Contact.MaxRecentContacts, cancellationToken)
                .ConfigureAwait(false), // Ok here
            _ => throw new ArgumentOutOfRangeException(nameof(tabId)),
            };
    }

    private void OnActiveTabChanged(Tab? tab) {
        if (!Enum.TryParse(tab?.Id ?? "", out _activeTabId))
            _activeTabId = default;
        _ = State.Recompute();
    }

    public enum TabId {
        Recent,
        All,
    }

    public sealed record Model {
        public static Model None { get; } = new() {
            PinnedContacts = new List<Contact>(),
            UnpinnedContacts = new List<Contact>(),
        };

        public List<Contact> PinnedContacts { get; init; } = null!;
        public List<Contact> UnpinnedContacts { get; init; } = null!;
    }
}
