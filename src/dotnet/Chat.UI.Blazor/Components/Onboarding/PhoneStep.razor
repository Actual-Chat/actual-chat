@namespace ActualChat.Chat.UI.Blazor.Components
@using System.ComponentModel.DataAnnotations
@inherits Step;

@if (CurrentStep != this) {
    return;
}

<div>
    <p class="text-title-1 text-center">Welcome to Actual Chat!</p>
    <p class="text-headline-1 mt-6">
        Please confirm your country code and enter your phone number.
        We collect this information to help you find your friends here.
    </p>
    <Form
        @ref="_formRef"
        Class="mt-6"
        Model="@_stepModel">
        <DataAnnotationsValidator/>
        <FormSection
            For="() => _stepModel.Phone"
            InputId="phone"
            Label="Phone"
            Class="grow"
            IsLabelInsideInput="true"
            IsRequired="@(!_hasPhoneIdentity)">
            <ChildContent>
                <InputText
                    id="phone"
                    @bind-Value="_stepModel.Phone"
                    autocomplete="tel"
                    type="tel"
                    inputmode="tel"
                    disabled="@_hasPhoneIdentity"/>
            </ChildContent>
            <Right>
                @if (_showPhoneVerificationStatus) {
                    <VerificationStatus IsVerified="_hasPhoneIdentity" Class="w-8 h-8" />
                }
            </Right>
        </FormSection>

        <FormSection
            For="() => _stepModel.Email"
            InputId="email"
            Label="Email"
            IsRequired="@(!_hasEmail)"
            IsLabelInsideInput="true">
            <InputText
                id="email"
                @bind-Value="_stepModel.Email"
                disabled="@(_hasEmail)"
                autocomplete="email"
                type="email"
                inputmode="email"/>
        </FormSection>
    </Form>
</div>

@code {
    private readonly PhoneStepModel _stepModel = new();
    private Form? _formRef;
    private bool _hasPhoneIdentity;
    private bool _hasEmail;
    private bool _showPhoneVerificationStatus;

    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IAccounts Accounts { get; init; } = null!;
    [Inject] private UICommander UICommander { get; init; } = null!;
    [Inject] private OnboardingUI OnboardingUI { get; init; } = null!;
    [Inject] private ModalUI ModalUI { get; init; } = null!;

    public override bool IsCompleted => OnboardingUI.Settings.Value.IsPhoneStepCompleted;

    protected override void MarkCompleted()
        => OnboardingUI.UpdateSettings(OnboardingUI.Settings.Value with { IsPhoneStepCompleted = true });

    protected override async Task OnInitializedAsync() {
        var account = await Accounts.GetOwn(Session, CancellationToken.None);
        _hasPhoneIdentity = account.User.HasPhoneIdentity();
        _showPhoneVerificationStatus = _hasPhoneIdentity;
        _hasEmail = !account.Email.IsNullOrEmpty();
        _stepModel.Email = account.Email;
        if (!account.Phone.IsNone) {
            _stepModel.Phone = account.Phone.ToReadable();
        }
    }

    protected override Task<bool> Validate() {
        var isValid = _formRef?.EditContext?.Validate() ?? false;
        return Task.FromResult(isValid);
    }

    protected override async Task<bool> Save() {
        // TODO: verify phone for email signin
        var phone = PhoneFormatterExt.FromReadable(_stepModel.Phone);
        var account = await Accounts.GetOwn(Session, default);
        var command = new Accounts_Update(
            Session,
            account with {
                Phone = phone,
                Email = _hasEmail ? account.Email : _stepModel.Email,
                },
            account.Version);
        var (_, error) = await UICommander.Run(command);
        if (error is not null)
            return false;

        if (!account.HasVerifiedPhone()) {
            var verificationModel = new PhoneVerificationModal.Model(phone);
            var modalRef = await ModalUI.Show(verificationModel);
            await modalRef.WhenClosed;
            _hasPhoneIdentity = verificationModel.IsVerified;
            if (verificationModel is { IsVerified: false, CanSkip: false })
                return false;
            _showPhoneVerificationStatus = true;
        }

        return true;
    }

    public class PhoneStepModel {
        [Required, PhoneNumber] public string Phone { get; set; } = PhoneCodes.Default.DisplayCode;
        [Required, EmailAddress] public string Email { get; set; } = "";
    }
}
