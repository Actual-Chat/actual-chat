@using ActualChat.Users
@namespace ActualChat.Chat.UI.Blazor.Components
@inherits ComputedStateComponent<ChatList.Model>
@{
    DebugLog?.LogDebug("Rendered: {List}, '{PlaceId}'", Kind, _placeId);
    var m = _rendered = State.Value;
    if (m is { ChatCount: 0, IsSearchModeOn: false })
        return;
}

@if (Kind == ChatListKind.Active) {
    if (m.ChatCount == 0)
        return;

    <div class="c-delimiter"></div>
    <div class="active-chats"
         data-bubble="@(BubbleRef.New<ActiveChatsBubble>())"
         data-bubble-priority="202"
         data-bubble-placement="@(FloatingPosition.BottomStart.ToPositionString())">
        <div class="c-title" data-tooltip="Chats where you are listening or recording right now">Active Chats</div>

        <div class="chat-list chat-list-active">
            @for (var i = 0; i < m.ChatCount; i++) {
                <ChatListItem ListKind="@Kind" Index="@i" />
            }
        </div>
    </div>
} else {
    @* ChatListKind.All *@
    <div class="chat-list chat-list-all">
        @for (var i = 0; i < m.ChatCount; i++) {
            if (i == 0) {
                <ChatListItem
                    ListKind="@Kind"
                    Index="@i"
                    data-bubble="@(BubbleRef.New<ChatListItemBubble>())"
                    data-bubble-priority="204"
                    data-bubble-placement="@(FloatingPosition.Bottom.ToPositionString())"/>

            } else {
                <ChatListItem ListKind="@Kind" Index="@i"/>
            }
        }
    </div>
}

@code {
    private Model _rendered;
    private ILogger? _log;
    private PlaceId _placeId;

    [Inject] private ChatHub ChatHub { get; init; } = null!;

    [Parameter, EditorRequired] public ChatListKind Kind { get; set; }
    [Parameter, EditorRequired] public string PlaceSid { get; set; } = "";

    private Session Session => ChatHub.Session;
    private ChatUI ChatUI => ChatHub.ChatUI;
    private ChatListUI ChatListUI => ChatHub.ChatListUI;
    private SearchUI SearchUI => ChatHub.SearchUI;
    private ILogger Log => _log ??= ChatHub.LogFor(GetType());
    private ILogger? DebugLog => Constants.DebugMode.ChatListComponents ? Log : null;

    protected override void OnInitialized() {
        _placeId = PlaceId.Parse(PlaceSid);
        DebugLog?.LogDebug("Initialized: {List}, {PlaceId}", Kind, _placeId);
        base.OnInitialized();
    }

    protected override void OnParametersSet() {
        _placeId = PlaceId.Parse(PlaceSid);
        base.OnParametersSet();
    }

    protected override ComputedState<Model>.Options GetStateOptions()
        => new() {
            InitialValue = new Model(ChatListUI.GetCountWhenLoading(Kind), false, true),
            Category = GetStateCategory(),
        };

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        DebugLog?.LogDebug("-> ComputeState: {List}, '{PlaceId}'", Kind, _placeId);
        var chatListCount = await ChatListUI.GetCount(Kind);
        if (chatListCount.PlaceId != _placeId) {
            DebugLog?.LogDebug("<- ComputeState: {List}, '{PlaceId}'." +
                " Invalid place. Expected: '{ExpectedPlaceId}', Actual: '{ActualPlaceId}'." +
                " Override count to 0",
                Kind, _placeId, _placeId, chatListCount.PlaceId);
            return new Model(0);
        }
        var chatCount = chatListCount.Count;
        if (Kind != ChatListKind.Active) {
            DebugLog?.LogDebug("<- ComputeState: {List}, '{PlaceId}'. Count={Count}", Kind, _placeId, chatCount);
            return new Model(chatCount);
        }

        var searchPhrase = await SearchUI.GetSearchPhrase(cancellationToken);
        DebugLog?.LogDebug("<- ComputeState: {List}, '{PlaceId}'. Count={Count}", Kind, _placeId, chatCount);
        return new Model(chatCount, !searchPhrase.IsEmpty);
    }

    protected override bool ShouldRender()
        => State.HasError || State.Value != _rendered;

    // Nested types

    public record struct Model(
        int ChatCount,
        bool IsSearchModeOn = false,
        bool IsLoading = false);
}
