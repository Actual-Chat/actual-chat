@namespace ActualChat.Chat.UI.Blazor.Components
@inherits ComputedStateComponent<ChatState>
@{
    var m = _rendered = State.Value;
    var chat = m.Chat;
    var info = m.Info;
    var lastTextEntry = info.LastTextEntry;
    var audioState = m.AudioState;
}

<NavbarItem
    Url="@($"/chat/{chat.Id}")"
    IsSelected="@m.IsSelected"
    data-menu="@(MenuRef.New<ChatMenu>(chat.Id, ListKind.Format()).ToString())"
    data-menu-placement="@(FloatingPosition.BottomStart.ToPositionString())">
    <ChildContent>
        <div class="flex-1 flex-x items-center gap-x-2" @onclick="()=>OnClick(chat.Id)">
            <ChatIcon Chat="m.Chat"/>
            <div class="grid justify-start items-start gap-y-1">
                <span class="text-headline-1 text-02 truncate">
                    <SearchUIHighlighter Text="@m.Chat.Title"/>
                </span>
                @if (lastTextEntry != null) {
                    <div class="text-xs text-03 truncate">
                        @if (m.Chat.Kind != ChatKind.Peer && !lastTextEntry.IsSystemEntry) {
                            <span>
                                <AuthorName Class="text-xs text-02 font-medium" AuthorSid="@lastTextEntry.AuthorId" ShowDetailsOnClick="false"/>:
                            </span>
                        }
                        @info.LastTextEntryText
                    </div>
                }
            </div>
        </div>
    </ChildContent>
    <Ending>
        @{
            var isWide = ScreenSize.IsWide();
            var isActiveChatList = ListKind == ChatListKind.Active;
            var isListeningOrRecording = m.IsListening || m.IsRecording;
            var hasButtons = isWide || isActiveChatList || isListeningOrRecording;
            var hasMenu = !isActiveChatList && isWide;
            var isHoverable = isWide && !isActiveChatList && !isListeningOrRecording;
        }
        <UnreadCountWithTime
            Value="@m.Info.UnreadCount"
            LastEntry="@m.Info.LastTextEntry"
            HideLastEntryTime="@isListeningOrRecording"
            NotificationMode="@m.Info.UserSettings.NotificationMode"
            HasMentions="m.Info.HasUnreadMentions"/>
        <div class="@(isHoverable ? "hoverable" : "") slot">
            @if (hasButtons) {
                @if (m.IsRecording) {
                    <ChatListRecordingToggle Chat="@chat" IsRecording="@audioState.IsRecording" Class="blackout"/>
                }
                <div class="@(hasMenu ? "" : "pr-1")">
                    <ChatListListenToggle AudioState="@audioState" Class="blackout"/>
                </div>
            }
            @if (hasMenu) {
                <div
                    class="menu"
                    data-menu="@(MenuRef.New<ChatMenu>(chat.Id, ListKind.Format()).ToString())"
                    data-menu-trigger="@MenuTrigger.Primary"
                    data-menu-placement="@(FloatingPosition.RightStart.ToPositionString())">

                    <ButtonRound Class="blackout" ContentClass="!bg-transparent">
                        <i class="icon-more-vertical text-2xl"></i>
                    </ButtonRound>
                </div>
            }
        </div>
    </Ending>
</NavbarItem>

@code {
    private ChatState? _rendered;

    [Inject] private ChatUI ChatUI { get; init; } = null!;

    [CascadingParameter] public ScreenSize ScreenSize { get; init; }
    [Parameter, EditorRequired] public ChatInfo ChatInfo { get; init; } = null!;
    [Parameter, EditorRequired] public ChatListKind ListKind { get; init; }

    protected override bool ShouldRender()
        => State.HasError || !ReferenceEquals(_rendered, State.Value);

    protected override ComputedState<ChatState>.Options GetStateOptions()
        => new() {
            InitialValue = new ChatState(ChatInfo, new ChatAudioState(ChatInfo.Id)),
            Category = GetStateCategory(),
        };

    protected override async Task<ChatState> ComputeState(CancellationToken cancellationToken)
    {
        var chatId = await ChatUI.FixChatId(ChatInfo.Id, cancellationToken).ConfigureAwait(false);
        var chatState = await ChatUI.GetState(chatId, false, cancellationToken).ConfigureAwait(false);
        return chatState ?? ChatState.None;
    }

    private async Task OnClick(ChatId chatId) {
        var tuneUI = ChatUI.Services.GetRequiredService<TuneUI>();
        _ = tuneUI.Play("select-chat");

        ChatUI.SelectChat(chatId);
        try {
            if (ScreenSize.IsWide())
                return;

            // This part hides LeftPanel when you select the chat
            var chatUrl = Links.Chat(ChatInfo.Id);
            var history = ChatUI.Services.GetRequiredService<History>();
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(0.5));
            await history
                .When(_ => history.LocalUrl.Value.OrdinalStartsWith(chatUrl), cts.Token)
                .SuppressCancellationAwait();
            await history.WhenNavigationCompleted;

            var panelsUI = ChatUI.Services.GetRequiredService<PanelsUI>();
            panelsUI.Left.SetIsVisible(false);
        }
        finally {
            StateHasChanged();
        }
    }
}
