@namespace ActualChat.Chat.UI.Blazor.Components
@using SearchUI = ActualChat.Chat.UI.Blazor.Services.SearchUI
@inherits ComputedStateComponent<ChatListItem.Model>
@{
    DebugLog?.LogDebug("Rendered: {ListKind} #{ChatTitle}, ChatId='{ChatId}'", ListKind, ChatInfo.Chat.Title, ChatInfo.Id);
    var m = State.Value;
    var chatState = m.ChatState;
    var chatInfo = ChatInfo;
    var chat = chatInfo.Chat;
    var isWide = ScreenSize.IsWide();
    var isActiveChatList = ListKind == ChatListKind.Active;
    var isListeningOrRecording = chatState.IsListening || chatState.IsRecording;
    var hasButtons = isWide || isActiveChatList || isListeningOrRecording;
    var lastTextEntry = chatInfo.LastTextEntry;
    var audioState = chatState.AudioState;
    var attributes = ListKind == ChatListKind.All && m.IsFirstItem
        ? FirstItemAttributes
        : NoneAttributes;
    _renderedModel = m;
}

<NavbarItem
    Url="@($"/chat/{chat.Id}")"
    ReplaceOnPrefix="/chat/"
    IsSelected="@(chatState.IsSelected && ListKind != ChatListKind.Active)"
    data-menu="@(MenuRef.New<ChatMenu>(chat.Id, ListKind.Format()).ToString())"
    data-menu-placement="@(FloatingPosition.BottomStart.ToPositionString())"
    @attributes="@attributes">
    <ChildContent>
        <div class="c-container">
            <ChatIcon Chat="@chatInfo.Chat" ShowPresence="@true"/>
            <div class="c-description">
                    <span class="c-chat-title">
                        <span>@chat.Title</span>
                        <span class="c-incut"></span>
                        @if (lastTextEntry != null && hasButtons && !isListeningOrRecording) {
                            <LastEntryTime LastEntry="@lastTextEntry"/>
                        }
                </span>
                @if (lastTextEntry != null) {
                    <div class="c-last-message">
                        @if (chatInfo.Chat.Kind != ChatKind.Peer && !lastTextEntry.IsSystemEntry) {
                                <span class="c-name">
                                <AuthorName AuthorSid="@lastTextEntry.AuthorId" ShowDetailsOnClick="false"/>:
                            </span>
                        }
                        @if (lastTextEntry.IsStreaming) {
                            <chat-list-item-streaming-svg class="w-4 h-4"/>
                        }
                        else {
                            <span class="c-text">
                                @chatInfo.LastTextEntryText
                            </span>
                        }
                            <div class="c-incut"></div>
                            @if (hasButtons && !isListeningOrRecording) {
                                <UnreadCount
                                    Value="@chatState.Info.UnreadCount"
                                    NotificationMode="@chatState.Info.UserSettings.NotificationMode"
                                    HasMentions="chatState.Info.HasUnreadMentions"/>
                            }
                    </div>
                }
            </div>
        </div>
    </ChildContent>
    <Ending>
        @{
            var hasMenu = !isActiveChatList && isWide;
            var isHoverable = isWide && !isActiveChatList && !isListeningOrRecording;
        }
        <div class="@(isHoverable ? "hoverable" : "") slot">
            <UnreadCount
                Value="@chatInfo.UnreadCount"
                NotificationMode="@chatInfo.UserSettings.NotificationMode"
                HasMentions="@chatInfo.HasUnreadMentions"/>
            @if (hasButtons) {
                @if (chatState.IsRecording) {
                    <ChatListRecordingToggle Chat="@chat" IsRecording="@audioState.IsRecording" Class="blackout"/>
                }
                <div class="@(hasMenu ? "" : "pr-1")">
                    <ChatListListenToggle AudioState="@audioState" Class="blackout"/>
                </div>
            }
            @if (hasMenu) {
                <div
                    class="menu"
                    data-menu="@(MenuRef.New<ChatMenu>(chat.Id, ListKind.Format()).ToString())"
                    data-menu-trigger="@MenuTrigger.Primary"
                    data-menu-placement="@(FloatingPosition.RightStart.ToPositionString())">

                    <HeaderButton Class="blackout">
                        <i class="icon-more-vertical text-2xl"></i>
                    </HeaderButton>
                </div>
            }
        </div>
    </Ending>
</NavbarItem>
@if (m.IsLastItemInBlock) {
    <Divider Class="mx-1 my-1.5"/>
}

@code {
    // Settings data-bubble attributes inside a component instead providing them from ChatList as additional attributes,
    // allows to avoid unnecessary OnParametersSet call during rendering ChatList and correspondingly
    // it allows to avoid extra ComputeState call and Rendering.
    private static readonly Dictionary<string, object> FirstItemAttributes = new() {
        { "data-bubble", BubbleRef.New<ChatListItemBubble>() },
        { "data-bubble-priority", 204 },
        { "data-bubble-placement", FloatingPosition.Bottom.ToPositionString() },
    };
    private static readonly Dictionary<string, object> NoneAttributes = new();

    private ILogger? _log;
    private Model? _renderedModel;

    [Inject] private ChatUIHub Hub { get; init; } = null!;
    private ChatUI ChatUI => Hub.ChatUI;
    private ChatListUI ChatListUI => Hub.ChatListUI;
    private SearchUI SearchUI => Hub.SearchUI;
    private ScreenSize ScreenSize => Hub.BrowserInfo.ScreenSize.Value;

    private ILogger Log => _log ??= Hub.LogFor(GetType());
    private ILogger? DebugLog => Constants.DebugMode.ChatListComponents ? Log : null;

    [Parameter, EditorRequired] public ChatListKind ListKind { get; set; } = ChatListKind.All;
    [Parameter, EditorRequired] public ChatInfo ChatInfo { get; set; } = ChatInfo.None;
    [Parameter] public bool IsLastItemInBlock { get; set; }
    [Parameter] public bool IsFirstItem { get; set; }

    public ChatListItem() {
        Options = ComputedStateComponentOptions.RecomputeOnParametersSet;
    }

    // protected override void OnInitialized() {
    //
    //     DebugLog?.LogDebug("Initialized: {ListKind} #{Index}", ListKind, Index);
    //     base.OnInitialized();
    // }
    //
    // protected override void OnParametersSet() {
    //     DebugLog?.LogDebug("OnParametersSet: {ListKind} #{Index}", ListKind, Index);
    //     base.OnParametersSet();
    // }

    protected override bool ShouldRender() {
        if (_renderedModel == null)
            return true;

        var m = State.LastNonErrorValue;
        var isTheSame = m.ChatInfo == _renderedModel.ChatInfo
            && m.ChatState == _renderedModel.ChatState
            && m.IsLastItemInBlock == _renderedModel.IsLastItemInBlock
            && m.IsFirstItem == _renderedModel.IsFirstItem;
        return !isTheSame;
    }

    protected override ComputedState<Model>.Options GetStateOptions()
        => ComputedStateComponent.GetStateOptions(GetType(),
            t => new ComputedState<Model>.Options {
                InitialValue = new () {
                    ChatState = new (ChatInfo, ChatAudioState.None),
                },
                Category = ComputedStateComponent.GetStateCategory(t),
            });

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken)
    {
         // We intentionally use .ConfigureAwait(false) here: this is one of the most frequently called methods.
         // Properties are copied to local vars because of this.
        var listKind = ListKind;
        var chatInfo = ChatInfo;
        var chatTitle = chatInfo.Chat.Title;
        var chatId = chatInfo.Chat.Id;
        var isLastItemInBlock = IsLastItemInBlock;
        var isFirstItem = IsFirstItem;
        DebugLog?.LogDebug("-> ComputeState: {ListKind} #{ChatTitle}", listKind, chatTitle);
        var chatState = await ChatUI.GetState(chatId, false, cancellationToken).ConfigureAwait(false);
        if (chatState == null) {
            DebugLog?.LogDebug("<- ComputeState: {ListKind} #{ChatTitle}, No ChatState", ListKind, chatTitle);
            return Model.None;
        }
        DebugLog?.LogDebug("<- ComputeState: {ListKind} #{ChatTitle}, OK, ChatId={ChatId}", ListKind, chatTitle, chatId);
        return new() {
            ChatState = chatState,
            ChatInfo = chatInfo,
            IsLastItemInBlock = isLastItemInBlock,
            IsFirstItem = isFirstItem,
        };
    }

    // Nested types

    public sealed record Model {
        public static readonly Model None = new() { ChatState = ChatState.None };

        public ChatState ChatState { get; init; } = ChatState.None;
        public ChatInfo ChatInfo { get; init; } = ChatInfo.None;
        public bool IsLastItemInBlock { get; init; }
        public bool IsFirstItem { get; init; }
    }
}
