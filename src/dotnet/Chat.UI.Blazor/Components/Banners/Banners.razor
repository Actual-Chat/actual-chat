@namespace ActualChat.Chat.UI.Blazor.Components
@inherits ComputedStateComponent<Banners.ComputedModel>
@{
    var m = State.Value;
}

<ReconnectBanner/>
@foreach (var banner in m.Banners.Take(MaxCount)) {
    @banner.View
}
<AddToContactsBanner Chat="@Chat"/>
<AddChatMembersBanner Chat="@Chat"/>
<PermissionBannerSwitch/>

@code {
    private const int MaxCount = 2;
    [Inject] private BannerUI BannerUI { get; init; } = null!;

    [Parameter, EditorRequired] public Chat Chat { get; set; } = null!;

    protected override ComputedState<ComputedModel>.Options GetStateOptions()
        => new() {
            InitialValue = ComputedModel.None,
            UpdateDelayer = FixedDelayer.Instant,
            Category = GetStateCategory(),
        };

    protected override async Task<ComputedModel> ComputeState(CancellationToken cancellationToken) {
        var bannerRefs = await BannerUI.Banners.Use(cancellationToken);
        return new(bannerRefs);
    }

    public sealed record ComputedModel(ImmutableList<BannerDef> Banners) {
        public static readonly ComputedModel None = new(ImmutableList<BannerDef>.Empty);
    }
}
