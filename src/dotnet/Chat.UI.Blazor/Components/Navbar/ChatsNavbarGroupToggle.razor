@namespace ActualChat.Chat.UI.Blazor.Components
@using ActualChat.Contacts
@inherits ComputedStateComponent<ChatsNavbarGroupToggle.Model>
@{
    var m = State.ValueOrDefault ?? new();
    var showBadge = m.Count.Value != 0;
}
<NavbarGroupToggle
    Title="Chats" Id="@NavbarGroupIds.Chats" Tooltip="Chats" FloatingPosition="FloatingPosition.Right" ShowBadge="@showBadge">
    <ChildContent>
        <i class="icon-message-ellipse text-2xl font-medium"></i>
    </ChildContent>
    <BadgeContent>
        @m.Count
    </BadgeContent>
</NavbarGroupToggle>

@code {
    [Inject] private ChatUI ChatUI { get; init; } = null!;

    protected override ComputedState<Model>.Options GetStateOptions() {
        return new() {
            UpdateDelayer = FixedDelayer.Get(5),
            InitialValue = new(),
        };
    }

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var chats = await ChatUI.List(ChatListOrder.ByLastEventTime, cancellationToken);
        var count = chats.Select(c => c.UnmutedUnreadCount).Sum();
        return new(count);
    }

    public sealed record Model(Trimmed<int> Count = default);
}
