@namespace ActualChat.Chat.UI.Blazor.Components
@inherits ComputedStateComponent<ChatsNavbarButtonBadge.Model>
@{
    var m = State.Value;
    _rendered = m;
    if (m.Count <= 0)
        return;
}

<Badge>@m.Count</Badge>

@code {
    private Model? _rendered;
    private PlaceId _placeId;

    [Inject] private ChatListUI ChatListUI { get; init; } = null!;

    [Parameter, EditorRequired] public string PlaceSid { get; set; } = "";

    protected override void OnInitialized() {
        _placeId = PlaceId.Parse(PlaceSid);
        base.OnInitialized();
    }

    protected override ComputedState<Model>.Options GetStateOptions() {
        return new() {
            InitialValue = new(),
            UpdateDelayer = FixedDelayer.Instant,
            Category = GetStateCategory(),
        };
    }

    protected override async Task<Model> ComputeState(CancellationToken cancellationToken) {
        var count = await ChatListUI.GetUnmutedUnreadChatCount(_placeId, cancellationToken);
        return new Model(count);
    }

    protected override bool ShouldRender()
        => State.HasError || State.Value != _rendered;

    public record struct Model(Trimmed<int> Count = default);
}
