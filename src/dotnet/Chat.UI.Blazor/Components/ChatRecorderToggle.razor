@namespace ActualChat.Audio.UI.Blazor.Components
@inherits ComputedStateComponent<Symbol>
@{
    var isRecordingInThisChat = RecordingChatId == ChatId;
    var recordingStatus = isRecordingInThisChat ? "on" : "off";
    var cls = $"audio-recorder-toggle {recordingStatus}";
}

@if (CanRecord) {
    <ButtonRound Class="@cls"
                  Click="OnClick"
                  @ontouchend="OnLongPressStop"
                  @onmouseup="OnLongPressStop"
                  @onlongpress="OnLongPressStart"
                  data-long-press-delay="200">
        <svg class="fill-current w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="1 1 24 24">
            <path d="M12.4 15.9C14.4 15.9 16.1 14.3 16.1 12.2V7.7C16.1 5.7 14.5 4 12.4 4C10.3 4 8.7 5.7 8.7 7.7V12.3C8.7 14.3 10.4 15.9 12.4 15.9ZM10.6 7.7C10.6 6.7 11.4 5.9 12.4 5.9C13.4 5.9 14.2 6.7 14.2 7.7V12.3C14.2 13.3 13.4 14.1 12.4 14.1C11.4 14.1 10.6 13.3 10.6 12.3V7.7Z"/>
            <path d="M18.8 12.3C18.8 11.8 18.4 11.4 17.9 11.4C17.4 11.4 17 11.8 17 12.3C17 14.8 14.9 16.9 12.4 16.9C9.9 16.9 7.8 14.8 7.8 12.3C7.8 11.8 7.4 11.4 6.9 11.4C6.4 11.4 6 11.8 6 12.3C6 15.5 8.4 18.2 11.5 18.6V20.5H13.3V18.6C16.4 18.2 18.8 15.5 18.8 12.3Z"/>
            <path d="M11.5 17.5V20.9C11.5 21.4 11.9 21.7 12.3 21.7H12.5C13 21.7 13.3 21.3 13.3 20.9V19V17.6H11.5V17.5Z"/>
        </svg>
    </ButtonRound>
} else {
    <ButtonSquare Class="@cls"
                  IsDisabled="true">
        <svg class="fill-current w-10 md:w-12 h-10 md:h-12 m-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="-4 -4 32 32">
            <path d="M16 11c0 2.209-1.791 4-4 4s-4-1.791-4-4v-7c0-2.209 1.791-4 4-4s4 1.791 4 4v7zm4-2v2c0 4.418-3.582 8-8 8s-8-3.582-8-8v-2h2v2c0 3.309 2.691 6 6 6s6-2.691 6-6v-2h2zm-7 13v-2h-2v2h-4v2h10v-2h-4z"/>
            <line x1="4" y1="2" x2="20" y2="20" stroke="currentColor" stroke-width="2"/>
        </svg>
    </ButtonSquare>
}

@code {
    [Inject] private ChatUI ChatUI { get; init; } = null!;
    [Inject] private AudioRecorder AudioRecorder { get; init; } = null!;

    [Parameter] public string ChatId { get; set; } = "";

    private Symbol RecordingChatId => State.ValueOrDefault;
    private bool IsLongPress { get; set; } = false;
    private bool CanRecord { get; set; } = true;

    protected override ComputedState<Symbol>.Options GetStateOptions()
        => new() { UpdateDelayer = UpdateDelayer.ZeroDelay };

    protected override async Task<Symbol> ComputeState(CancellationToken cancellationToken) {
        return await ChatUI.RecordingChatId.Use(cancellationToken).ConfigureAwait(false);
    }

    private async Task OnClick() {
        var isRecordingInThisChat = RecordingChatId == ChatId;
        if (isRecordingInThisChat) {
            ChatUI.RecordingChatId.Value = Symbol.Empty;
            return;
        }
        CanRecord = await AudioRecorder.CanRecord().ConfigureAwait(true);
        if (!CanRecord) {
            StateHasChanged();
            return;
        }
        ChatUI.RecordingChatId.Value = ChatId;
    }

    private async Task OnLongPressStart() {
        if (IsLongPress)
            return;
        CanRecord = await AudioRecorder.CanRecord().ConfigureAwait(true);
        if (!CanRecord) {
            StateHasChanged();
            return;
        }
        IsLongPress = true;
        ChatUI.RecordingChatId.Value = ChatId;
    }

    private void OnLongPressStop() {
        if (!IsLongPress)
            return;
        IsLongPress = false;
        ChatUI.RecordingChatId.Value = Symbol.Empty;
    }
}
