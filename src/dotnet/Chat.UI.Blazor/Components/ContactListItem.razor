@using ActualChat.Contacts
@inherits ComputedStateComponent<ChatState>
@{
    var m = State.ValueOrDefault ?? ChatState.Loading;
    if (m.Chat.Id.IsNone)
        return;

    var isMenuVisible = m.IsListening || m.IsRecording;
    var cls = isMenuVisible ? "visible-menu" : "invisible-menu";
}

<NavbarItem
    Url="@(Links.ChatPage(m.Chat.Id))"
    IsOnline="@m.Presence.IsOnline()"
    IsSelected="@m.IsSelected"
    data-menu="@(MenuRef.New<ContactMenu>(Contact.Id).ToString())"
    data-menu-trigger="@((MenuTriggers.LongClick | MenuTriggers.RightClick).Format())"
    data-menu-position="@(FloatingPosition.BottomStart.ToPositionString())"
    data-long-press-delay="500">
    <ChildContent>
        <div class="flex-x items-center gap-x-2">
            <AccountCircle UserId="@Contact.Account.Id" ShowPresence="true"/>
            <span class="text-headline-1 text-02 text-ellipsis whitespace-nowrap overflow-hidden">
                <SearchUIHighlighter Text="@Contact.Account!.Avatar.Name"/>
            </span>
        </div>
    </ChildContent>
    <Ending>
        <div class="@cls">
            <ChatListListenToggle ChatId="@m.Chat.Id" Class="chat-menu-btn blackout"/>
            <ChatListRecordingToggle ChatId="@m.Chat.Id" Class="chat-menu-btn blackout"/>
            <div class="flex"
                 data-menu="@(MenuRef.New<ContactMenu>(Contact.Id).ToString())"
                 data-menu-trigger="@(MenuTriggers.LeftClick.Format())"
                 data-menu-position="@(FloatingPosition.RightStart.ToPositionString())">
                <ButtonRound
                    ContentClass="!bg-transparent"
                    Class="chat-menu-btn blackout">
                    <i class="icon-more-vertical text-2xl"></i>
                </ButtonRound>
                <div class="absolute -right-6">
                    <div class="placement -mt-2">
                    </div>
                </div>
            </div>
        </div>
    </Ending>
</NavbarItem>

@code {
    [Inject] private ChatUI ChatUI { get; init; } = null!;

    [Parameter, EditorRequired] public Contact Contact { get; set; } = null!;

    protected override ComputedState<ChatState>.Options GetStateOptions()
        => new () { InitialValue = ChatState.Loading };

    protected override async Task<ChatState> ComputeState(CancellationToken cancellationToken) {
        var state = await ChatUI.GetState(Contact.ChatId, true, cancellationToken).ConfigureAwait(false);
        return state ?? ChatState.None;
    }
}
