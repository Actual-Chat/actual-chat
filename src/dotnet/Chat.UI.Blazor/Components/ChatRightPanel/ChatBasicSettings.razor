@namespace ActualChat.Chat.UI.Blazor.Components
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Headers

<Form Model="@_form" OnValidSubmit="@OnSave">
    <DataAnnotationsValidator/>

    <div class="pb-2 mb-4 border-b border-bg-03">
        <FormSection>
            <ChatMuteToggle ChatId="@Chat.Id" />
        </FormSection>
    </div>

    <ChatIcon
        ShowImagePicker="true"
        ImageUploadUrl="@_form.ImageUploadUrl"
        ImagePicked="OnImagePicked"
        PictureClick="OnPictureClick"
        Size="SquareSize.Size20"
        Title="@_form.Title"
        Picture="@_form.Picture">
    </ChatIcon>

    <FormSection Label="Chat title" InputId="@_form.TitleId" IsRequired="true">
        <TextBox @bind-Value="@_form.Title" id="@_form.TitleId" Autofocus="true" Class="right-panel-input"/>
    </FormSection>

    <FormSection Class="flex h-12 md:h-8 justify-center">
        <ToggleEdit Id="@_form.IsPublicId" Label="Public chat &ndash; anyone can join" @bind-Value="_form.IsPublic"/>
    </FormSection>

    <div class="mt-3 flex-x justify-end">
        <Button Type="@ButtonType.Submit" IsDisabled="@(!context.Validate())">Save</Button>
    </div>
</Form>

@code {
    [Inject] private Session Session { get; init; } = null!;
    [Inject] private IChats Chats { get; init; } = null!;
    [Inject] private ComponentIdGenerator ComponentIdGenerator { get; init; } = null!;
    [Inject] private ImagePreviewUI ImagePreviewUI { get; init; } = null!;
    [Inject] private ContentUrlMapper ContentUrlMapper { get; init; } = null!;
    [Inject] private UICommander UICommander { get; init; } = null!;
    [Inject] private DiffEngine DiffEngine { get; init; } = null!;

    private FormModel _form = null!;

    [CascadingParameter] public Chat Chat { get; set; } = null!;

    protected override Task OnParametersSetAsync() {
        _form ??= new(ComponentIdGenerator);
        _form.Title = Chat.Title;
        _form.Picture = Chat.Picture;
        _form.IsPublic = Chat.IsPublic;
        _form.ImageUploadUrl = $"/api/chats/{Chat.Id}/upload-picture";
        return Task.CompletedTask;
    }

    private async Task OnSave() {
        var newChat = Chat with {
            Title = _form.Title,
            IsPublic = _form.IsPublic,
            Picture = _form.Picture,
        };
        var cmd = new IChats.ChangeChatCommand(Session, Chat.Id, Chat.Version, new() {
            Update = DiffEngine.Diff<Chat, ChatDiff>(Chat, newChat),
        });
        await UICommander.Run(cmd);
    }

    public sealed class FormModel
    {
        [Required] public string Title { get; set; } = "";
        public string Picture { get; set; } = "";
        public bool IsPublic { get; set; }
        public string ImageUploadUrl { get; set; } = "";

        public string FormId { get; }
        public string TitleId { get; }
        public string PictureId { get; }
        public string IsPublicId { get; }

        public FormModel(ComponentIdGenerator componentIdGenerator) {
            FormId = componentIdGenerator.Next("new-chat-form");
            TitleId = $"{FormId}-title";
            PictureId = $"{FormId}-picture";
            IsPublicId = $"{FormId}-is-public";
        }
    }

    private void OnImagePicked(string imageUrl) {
        _form.Picture = imageUrl;
    }

    private async Task OnPictureClick(MouseEventArgs arg) {
        var url = ContentUrlMapper.ContentUrl(_form.Picture);
        await ImagePreviewUI.Show(url);
    }
}
