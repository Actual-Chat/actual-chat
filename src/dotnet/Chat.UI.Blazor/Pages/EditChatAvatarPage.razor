@page "/chat/{ChatId}/edit/avatar"

@if (!_avatarId.IsNullOrEmpty()) {
    <UserAvatarEditor AvatarId="@_avatarId" CancelRequested="NavigateToChat" OnUpdated="NavigateToChat" />
}

@code {
    [Inject] private NavigationManager Nav { get; set; } = default!;
    [Inject] private Session Session { get; set; } = default!;
    [Inject] private IChatAuthors ChatAuthors { get; set; } = default!;
    [Inject] private IUserAvatars UserAvatars { get; set; } = default!;
    [Inject] private IAuth Auth { get; set; } = default!;

    [Parameter]
    public string ChatId { get; set; } = "";

    private string _avatarId = "";

    protected override async Task OnParametersSetAsync() {

        var user = await Auth.GetUser(Session, default);
        if (user.IsAuthenticated) {
            // pick one avatar from user's list
        } else {
            var chatAuthor = await ChatAuthors.GetChatAuthor(Session, ChatId, default);
            if (chatAuthor != null) {
                // edit default chat user avatar
                var chatAuthorId = chatAuthor?.Id ?? "---";
                _avatarId = "1:" + chatAuthorId + ":1";
            }
        }
    }

    private void NavigateToChat() {
        Nav.NavigateTo($"/chat/{ChatId}");
    }
}
