using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace ActualChat.Users.Migrations
{
    /// <inheritdoc />
    public partial class NormalizePhone : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.Sql("""
                drop table if exists phone_codes;
                create temp table phone_codes
                (
                    code text primary key
                );

                insert into phone_codes
                select *
                from (values ('+93'),
                             ('+355'),
                             ('+213'),
                             ('+1 684'),
                             ('+376'),
                             ('+244'),
                             ('+1 264'),
                             ('+672 1'),
                             ('+1 268'),
                             ('+54'),
                             ('+374'),
                             ('+297'),
                             ('+247'),
                             ('+61'),
                             ('+43'),
                             ('+994'),
                             ('+1 242'),
                             ('+973'),
                             ('+880'),
                             ('+1 246'),
                             ('+375'),
                             ('+32'),
                             ('+501'),
                             ('+229'),
                             ('+1 441'),
                             ('+975'),
                             ('+591'),
                             ('+599'),
                             ('+387'),
                             ('+267'),
                             ('+55'),
                             ('+1 284'),
                             ('+673'),
                             ('+359'),
                             ('+226'),
                             ('+257'),
                             ('+238'),
                             ('+855'),
                             ('+237'),
                             ('+1'),
                             ('+1 345'),
                             ('+236'),
                             ('+235'),
                             ('+56'),
                             ('+86'),
                             ('+57'),
                             ('+269'),
                             ('+243'),
                             ('+242'),
                             ('+682'),
                             ('+506'),
                             ('+225'),
                             ('+385'),
                             ('+53'),
                             ('+357'),
                             ('+420'),
                             ('+45'),
                             ('+246'),
                             ('+253'),
                             ('+1 767'),
                             ('+593'),
                             ('+20'),
                             ('+503'),
                             ('+240'),
                             ('+291'),
                             ('+372'),
                             ('+268'),
                             ('+251'),
                             ('+500'),
                             ('+298'),
                             ('+679'),
                             ('+358'),
                             ('+33'),
                             ('+594'),
                             ('+689'),
                             ('+241'),
                             ('+220'),
                             ('+995'),
                             ('+49'),
                             ('+233'),
                             ('+350'),
                             ('+30'),
                             ('+299'),
                             ('+1 473'),
                             ('+590'),
                             ('+1 671'),
                             ('+502'),
                             ('+224'),
                             ('+245'),
                             ('+592'),
                             ('+509'),
                             ('+504'),
                             ('+852'),
                             ('+36'),
                             ('+354'),
                             ('+91'),
                             ('+62'),
                             ('+98'),
                             ('+964'),
                             ('+353'),
                             ('+972'),
                             ('+39'),
                             ('+81'),
                             ('+962'),
                             ('+7'),
                             ('+254'),
                             ('+686'),
                             ('+383'),
                             ('+965'),
                             ('+996'),
                             ('+856'),
                             ('+371'),
                             ('+961'),
                             ('+266'),
                             ('+231'),
                             ('+218'),
                             ('+423'),
                             ('+370'),
                             ('+352'),
                             ('+853'),
                             ('+261'),
                             ('+265'),
                             ('+60'),
                             ('+960'),
                             ('+223'),
                             ('+356'),
                             ('+692'),
                             ('+596'),
                             ('+222'),
                             ('+230'),
                             ('+52'),
                             ('+691'),
                             ('+373'),
                             ('+377'),
                             ('+976'),
                             ('+382'),
                             ('+1 664'),
                             ('+212'),
                             ('+258'),
                             ('+95'),
                             ('+264'),
                             ('+674'),
                             ('+977'),
                             ('+31'),
                             ('+687'),
                             ('+64'),
                             ('+505'),
                             ('+227'),
                             ('+234'),
                             ('+683'),
                             ('+672 3'),
                             ('+850'),
                             ('+389'),
                             ('+1 670'),
                             ('+47'),
                             ('+968'),
                             ('+92'),
                             ('+680'),
                             ('+970'),
                             ('+507'),
                             ('+675'),
                             ('+595'),
                             ('+51'),
                             ('+63'),
                             ('+48'),
                             ('+351'),
                             ('+974'),
                             ('+262'),
                             ('+40'),
                             ('+250'),
                             ('+290'),
                             ('+1 869'),
                             ('+1 758'),
                             ('+508'),
                             ('+1 784'),
                             ('+685'),
                             ('+378'),
                             ('+239'),
                             ('+966'),
                             ('+221'),
                             ('+381'),
                             ('+248'),
                             ('+232'),
                             ('+65'),
                             ('+1 721'),
                             ('+421'),
                             ('+386'),
                             ('+677'),
                             ('+252'),
                             ('+27'),
                             ('+82'),
                             ('+211'),
                             ('+34'),
                             ('+94'),
                             ('+249'),
                             ('+597'),
                             ('+46'),
                             ('+41'),
                             ('+963'),
                             ('+886'),
                             ('+992'),
                             ('+255'),
                             ('+66'),
                             ('+670'),
                             ('+228'),
                             ('+690'),
                             ('+676'),
                             ('+1 868'),
                             ('+216'),
                             ('+90'),
                             ('+993'),
                             ('+1 649'),
                             ('+688'),
                             ('+256'),
                             ('+380'),
                             ('+971'),
                             ('+44'),
                             ('+598'),
                             ('+998'),
                             ('+678'),
                             ('+58'),
                             ('+84'),
                             ('+1 340'),
                             ('+681'),
                             ('+967'),
                             ('+260'),
                             ('+263')) as t (code)
                order by t.code desc, length(t.code) desc;

                drop function if exists pg_temp.normalize_phone;
                create function pg_temp.normalize_phone(phone TEXT)
                    RETURNS TEXT AS
                $$
                declare
                    code   TEXT;
                    number TEXT;
                begin
                    select pc.code
                    into code
                    from phone_codes pc
                    where phone ^@ (pc.code || ' ')
                    limit 1;
                    if (code is null or code = '') then
                        return '';
                    end if;

                    number := replace(phone, code, '');
                    number := regexp_replace(number, '\D', '', 'g');
                    code := regexp_replace(code, '\D', '', 'g');
                    return code || '-' || number;
                end;
                $$ language plpgsql immutable ;

                update accounts
                set phone = pg_temp.normalize_phone(phone)
                where phone != '';
                """);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.Sql("""
                drop table if exists phone_codes;
                create temp table phone_codes
                (
                    code text primary key,
                    denormalized_code text
                );

                insert into phone_codes
                select regexp_replace(t.code, '\D', '', 'g'), t.code
                from (values ('+93'),
                             ('+355'),
                             ('+213'),
                             ('+1 684'),
                             ('+376'),
                             ('+244'),
                             ('+1 264'),
                             ('+672 1'),
                             ('+1 268'),
                             ('+54'),
                             ('+374'),
                             ('+297'),
                             ('+247'),
                             ('+61'),
                             ('+43'),
                             ('+994'),
                             ('+1 242'),
                             ('+973'),
                             ('+880'),
                             ('+1 246'),
                             ('+375'),
                             ('+32'),
                             ('+501'),
                             ('+229'),
                             ('+1 441'),
                             ('+975'),
                             ('+591'),
                             ('+599'),
                             ('+387'),
                             ('+267'),
                             ('+55'),
                             ('+1 284'),
                             ('+673'),
                             ('+359'),
                             ('+226'),
                             ('+257'),
                             ('+238'),
                             ('+855'),
                             ('+237'),
                             ('+1'),
                             ('+1 345'),
                             ('+236'),
                             ('+235'),
                             ('+56'),
                             ('+86'),
                             ('+57'),
                             ('+269'),
                             ('+243'),
                             ('+242'),
                             ('+682'),
                             ('+506'),
                             ('+225'),
                             ('+385'),
                             ('+53'),
                             ('+357'),
                             ('+420'),
                             ('+45'),
                             ('+246'),
                             ('+253'),
                             ('+1 767'),
                             ('+593'),
                             ('+20'),
                             ('+503'),
                             ('+240'),
                             ('+291'),
                             ('+372'),
                             ('+268'),
                             ('+251'),
                             ('+500'),
                             ('+298'),
                             ('+679'),
                             ('+358'),
                             ('+33'),
                             ('+594'),
                             ('+689'),
                             ('+241'),
                             ('+220'),
                             ('+995'),
                             ('+49'),
                             ('+233'),
                             ('+350'),
                             ('+30'),
                             ('+299'),
                             ('+1 473'),
                             ('+590'),
                             ('+1 671'),
                             ('+502'),
                             ('+224'),
                             ('+245'),
                             ('+592'),
                             ('+509'),
                             ('+504'),
                             ('+852'),
                             ('+36'),
                             ('+354'),
                             ('+91'),
                             ('+62'),
                             ('+98'),
                             ('+964'),
                             ('+353'),
                             ('+972'),
                             ('+39'),
                             ('+81'),
                             ('+962'),
                             ('+7'),
                             ('+254'),
                             ('+686'),
                             ('+383'),
                             ('+965'),
                             ('+996'),
                             ('+856'),
                             ('+371'),
                             ('+961'),
                             ('+266'),
                             ('+231'),
                             ('+218'),
                             ('+423'),
                             ('+370'),
                             ('+352'),
                             ('+853'),
                             ('+261'),
                             ('+265'),
                             ('+60'),
                             ('+960'),
                             ('+223'),
                             ('+356'),
                             ('+692'),
                             ('+596'),
                             ('+222'),
                             ('+230'),
                             ('+52'),
                             ('+691'),
                             ('+373'),
                             ('+377'),
                             ('+976'),
                             ('+382'),
                             ('+1 664'),
                             ('+212'),
                             ('+258'),
                             ('+95'),
                             ('+264'),
                             ('+674'),
                             ('+977'),
                             ('+31'),
                             ('+687'),
                             ('+64'),
                             ('+505'),
                             ('+227'),
                             ('+234'),
                             ('+683'),
                             ('+672 3'),
                             ('+850'),
                             ('+389'),
                             ('+1 670'),
                             ('+47'),
                             ('+968'),
                             ('+92'),
                             ('+680'),
                             ('+970'),
                             ('+507'),
                             ('+675'),
                             ('+595'),
                             ('+51'),
                             ('+63'),
                             ('+48'),
                             ('+351'),
                             ('+974'),
                             ('+262'),
                             ('+40'),
                             ('+250'),
                             ('+290'),
                             ('+1 869'),
                             ('+1 758'),
                             ('+508'),
                             ('+1 784'),
                             ('+685'),
                             ('+378'),
                             ('+239'),
                             ('+966'),
                             ('+221'),
                             ('+381'),
                             ('+248'),
                             ('+232'),
                             ('+65'),
                             ('+1 721'),
                             ('+421'),
                             ('+386'),
                             ('+677'),
                             ('+252'),
                             ('+27'),
                             ('+82'),
                             ('+211'),
                             ('+34'),
                             ('+94'),
                             ('+249'),
                             ('+597'),
                             ('+46'),
                             ('+41'),
                             ('+963'),
                             ('+886'),
                             ('+992'),
                             ('+255'),
                             ('+66'),
                             ('+670'),
                             ('+228'),
                             ('+690'),
                             ('+676'),
                             ('+1 868'),
                             ('+216'),
                             ('+90'),
                             ('+993'),
                             ('+1 649'),
                             ('+688'),
                             ('+256'),
                             ('+380'),
                             ('+971'),
                             ('+44'),
                             ('+598'),
                             ('+998'),
                             ('+678'),
                             ('+58'),
                             ('+84'),
                             ('+1 340'),
                             ('+681'),
                             ('+967'),
                             ('+260'),
                             ('+263')) as t (code)
                order by t.code desc, length(t.code) desc;

                drop function if exists pg_temp.denormalize_phone;
                create function pg_temp.denormalize_phone(phone TEXT)
                    RETURNS TEXT AS
                $$
                declare
                    code   TEXT;
                    denormalized_code   TEXT;
                    number TEXT;
                begin
                    select pc.code, pc.denormalized_code
                    into code, denormalized_code
                    from phone_codes pc
                    where phone ^@ (pc.code || '-')
                    limit 1;
                    if (denormalized_code is null or denormalized_code = '') then
                        return '';
                    end if;

                    number := replace(phone, code || '-', '');
                    return denormalized_code || ' ' || number;
                end;
                $$ language plpgsql immutable ;

                update accounts
                set phone = pg_temp.denormalize_phone(phone)
                where phone != '';
                """);
        }
    }
}
